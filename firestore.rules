rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---
    // Retorna os dados do utilizador autenticado
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Verifica se o utilizador autenticado é um Super Admin
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && getUserData().role == 'super-admin';
    }

    // Verifica se o utilizador autenticado é um Administrador de uma empresa
    function isAdmin() {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid))
               && getUserData().role == 'admin';
    }

    // Verifica se o documento que está a ser acedido pertence à empresa do utilizador
    function isUserCompany(companyId) {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid))
               && getUserData().companyId == companyId;
    }

    // --- REGRAS POR COLEÇÃO ---

    // Coleção de Utilizadores
    match /users/{userId} {
      // LEITURA: Um utilizador pode ler o seu próprio perfil. Super-admins podem ler qualquer perfil.
      allow read: if request.auth.uid == userId || isSuperAdmin();

      // CRIAÇÃO: Super-admins podem criar qualquer utilizador. Admins podem criar utilizadores para a sua própria empresa.
      allow create: if isSuperAdmin() ||
                       (isAdmin() && request.resource.data.companyId == getUserData().companyId);

      // ATUALIZAÇÃO: Um utilizador pode atualizar o seu próprio perfil. Super-admins e Admins podem atualizar utilizadores da sua empresa.
      allow update: if request.auth.uid == userId || isSuperAdmin() ||
                       (isAdmin() && resource.data.companyId == getUserData().companyId);

      // EXCLUSÃO: Ninguém pode apagar documentos de utilizadores diretamente. A exclusão é feita via `update` (active: false).
      allow delete: if false;
    }

    // Coleção de Empresas
    match /companies/{companyId} {
      // Super-admins podem fazer tudo.
      allow read, write: if isSuperAdmin();
      // Qualquer utilizador pode ler os dados da sua própria empresa.
      allow read: if isUserCompany(companyId);
    }

    // Coleção de Configurações da Empresa (ex: logo)
    match /config/{companyId} {
        // Super-admins e utilizadores da empresa podem ler e escrever.
        allow read, write: if isSuperAdmin() || isUserCompany(companyId);
    }

    // Regra genérica para coleções de DADOS (fazendas, registros, perdas, etc.)
    match /{collection}/{docId}
      where collection in ['fazendas', 'personnel', 'registros', 'perdas', 'planos', 'harvestPlans', 'armadilhas', 'cigarrinha'] {

      // Super-admins podem fazer tudo.
      allow read, write: if isSuperAdmin();

      // Utilizadores só podem aceder a dados da sua própria empresa.
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }
  }
}