rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNÇÕES AUXILIARES ---
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && getUserData().role == 'super-admin';
    }

    function isAdmin() {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid))
               && getUserData().role == 'admin';
    }

    function isUserCompany(companyId) {
        return exists(/databases/$(database)/documents/users/$(request.auth.uid))
               && getUserData().companyId == companyId;
    }

    // --- REGRAS POR COLEÇÃO ---

    // Coleção de Utilizadores
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isSuperAdmin();
      allow create: if isSuperAdmin() || (isAdmin() && request.resource.data.companyId == getUserData().companyId);
      allow update: if request.auth.uid == userId || isSuperAdmin() || (isAdmin() && resource.data.companyId == getUserData().companyId);
      allow delete: if false; // A exclusão é feita via `update` (active: false).
    }

    // Coleção de Empresas
    match /companies/{companyId} {
      // Super-admins podem fazer tudo.
      allow read, write: if isSuperAdmin();
      // Qualquer utilizador autenticado pode ler os dados da sua própria empresa para validação.
      allow get: if request.auth != null && isUserCompany(companyId);
    }

    // Coleção de Configurações da Empresa (ex: logo, shapefileURL)
    match /config/{companyId} {
        allow read, write: if isSuperAdmin() || isUserCompany(companyId);
    }

    // Coleção de Rascunhos de Planos de Colheita
    match /userDrafts/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    // --- REGRAS PARA COLEÇÕES DE DADOS DA EMPRESA ---
    // A lógica é a mesma para todas:
    // - Super Admin pode ler e escrever tudo.
    // - Utilizadores podem criar dados para a sua própria empresa.
    // - Utilizadores podem ler, atualizar e apagar dados que pertencem à sua empresa.

    match /fazendas/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }

    match /personnel/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }

    match /registros/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }

    match /perdas/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }

    match /planos/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }

    match /harvestPlans/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }

    match /armadilhas/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }

    match /cigarrinha/{docId} {
      allow read, write: if isSuperAdmin();
      allow create: if request.resource.data.companyId == getUserData().companyId;
      allow read, update, delete: if resource.data.companyId == getUserData().companyId;
    }
  }
}