rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Função auxiliar para verificar a função do utilizador
    function getUserRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }

    // Função auxiliar para verificar o companyId do utilizador
    function getUserCompanyId(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.companyId;
    }

    // Função para verificar se o utilizador é um super-admin
    function isSuperAdmin(userId) {
      return getUserRole(userId) == 'super-admin';
    }

    // Regra para a coleção 'companies'
    match /companies/{companyId} {
      // Super-admins podem fazer tudo.
      // Utilizadores normais podem ler os dados da sua própria empresa.
      allow read: if isSuperAdmin(request.auth.uid) || getUserCompanyId(request.auth.uid) == companyId;
      // Apenas super-admins podem criar, atualizar ou apagar empresas.
      allow write: if isSuperAdmin(request.auth.uid);
    }

    // Regra para a coleção 'config' (logotipos, etc.)
    match /config/{companyId} {
        // Super-admins podem ler tudo.
        // Utilizadores podem ler e escrever a configuração da sua própria empresa.
        allow read: if isSuperAdmin(request.auth.uid) || getUserCompanyId(request.auth.uid) == companyId;
        allow write: if isSuperAdmin(request.auth.uid) || getUserCompanyId(request.auth.uid) == companyId;
    }

    // Regra genérica para todas as outras coleções com dados de empresas
    match /{collection}/{docId} {
      // Super-admins podem ler e escrever em qualquer coleção.
      allow read, write: if isSuperAdmin(request.auth.uid);

      // Regras para utilizadores não-super-admins
      allow read, update, delete: if !isSuperAdmin(request.auth.uid) &&
                                     resource.data.companyId == getUserCompanyId(request.auth.uid);

      // A criação é permitida se o novo documento tiver o companyId correto.
      // Esta regra é a correção CRÍTICA para o bug de login do administrador.
      allow create: if !isSuperAdmin(request.auth.uid) &&
                       request.resource.data.companyId == getUserCompanyId(request.auth.uid);
    }
  }
}