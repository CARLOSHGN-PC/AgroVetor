<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AgroVetor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script>
    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
    <!-- Turf.js for spatial analysis -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
     <!-- Crypto-JS for offline password hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>

<body class="theme-green">

    <div id="splash-screen">
        <div class="logo">
            <img src="icons/icon-512x512.png" alt="AgroVetor Logo">
            <h1>AgroVetor</h1>
        </div>
    </div>


    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-progress-text">A carregar...</p>
    </div>

    <div id="appScreen" style="display:none;">
        <header>
            <div class="header-left">
                <button id="btnToggleMenu" class="menu-toggle-btn">
                    <i class="fas fa-bars"></i>
                </button>
                 <div class="logo-container">
                    <img src="icons/icon-192x192.png" alt="Logo" id="headerLogo">
                    <h1></h1>
                </div>
            </div>
            <div classs="header-center">
                 <div id="currentDateTime"></div>
            </div>
            <div class="header-right">
                <!-- Ícone de Sino de Notificação -->
                <div id="notification-bell-container" class="dropdown-container">
                    <button id="notification-bell-toggle" class="header-icon-btn">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count" class="notification-badge"></span>
                    </button>
                    <div id="notification-dropdown" class="dropdown-menu notification-dropdown">
                        <div class="notification-header">
                            <h3>Notificações</h3>
                            <button id="clear-notifications-btn">Limpar Tudo</button>
                        </div>
                        <div id="notification-list">
                            <!-- Itens de notificação serão inseridos aqui -->
                        </div>
                        <div id="no-notifications" class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <p>Nenhuma notificação nova</p>
                        </div>
                    </div>
                </div>

                <!-- Menu do Utilizador -->
                <div id="user-menu-container" class="dropdown-container">
                    <button id="user-menu-toggle" class="user-menu-btn" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-user-circle"></i>
                        <span id="userMenuUsername">Utilizador</span>
                        <i class="fas fa-chevron-down arrow"></i>
                    </button>
                    <div id="user-menu-dropdown" class="dropdown-menu">
                        <button id="changePasswordBtn"><i class="fas fa-key"></i> Alterar Senha</button>
                        <button id="manualSyncBtn"><i class="fas fa-sync"></i> Sincronizar Agora</button>
                        <button id="btnEnableOfflineLogin"><i class="fas fa-user-lock"></i> Login Offline</button>
                        <button id="installAppBtn" style="display: none;"><i class="fas fa-download"></i> Instalar App</button>
                        <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</button>
                        <div class="theme-selector">
                            <button id="theme-green" class="theme-button active" data-theme="theme-green" title="Tema Verde"></button>
                            <button id="theme-blue" class="theme-button" data-theme="theme-blue" title="Tema Azul"></button>
                            <button id="theme-dark" class="theme-button" data-theme="theme-dark" title="Tema Escuro"></button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <nav id="menu"></nav>

        <main id="content">
            <!-- Conteúdo dinâmico das abas -->
            <div id="dashboard" class="tab-content active">
                <div id="dashboard-selector">
                    <!-- Cards para selecionar o tipo de dashboard -->
                    <div class="dashboard-card" id="card-broca">
                        <i class="fas fa-bug"></i>
                        <h3>Broca</h3>
                        <p>Análises e KPIs sobre a infestação da broca-da-cana.</p>
                    </div>
                    <div class="dashboard-card" id="card-perda">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>Perda de Colheita</h3>
                        <p>Indicadores sobre as perdas na colheita mecanizada.</p>
                    </div>
                     <div class="dashboard-card" id="card-aerea">
                        <i class="fas fa-satellite-dish"></i>
                        <h3>Monitoramento Aéreo</h3>
                        <p>Dados e alertas do monitoramento aéreo de pragas.</p>
                    </div>
                    <div class="dashboard-card" id="card-plantio">
                        <i class="fas fa-seedling"></i>
                        <h3>Plantio</h3>
                        <p>Acompanhamento e metas de plantio.</p>
                    </div>
                    <div class="dashboard-card" id="card-cigarrinha">
                        <i class="fas fa-leaf"></i>
                        <h3>Cigarrinha</h3>
                        <p>Monitoramento e índices de infestação da cigarrinha.</p>
                    </div>
                     <div class="dashboard-card" id="card-clima">
                        <i class="fas fa-cloud-sun-rain"></i>
                        <h3>Climatologia</h3>
                        <p>Análise de dados climatológicos e seus impactos.</p>
                    </div>
                </div>

                <div id="dashboard-broca" style="display: none;" class="dashboard-view">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-bug"></i> Dashboard de Broca</h2>
                        <button class="btn-back-to-selector" id="btn-back-to-selector-broca"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="filters">
                        <input type="date" id="brocaDashboardInicio">
                        <input type="date" id="brocaDashboardFim">
                        <button id="btnFiltrarBrocaDashboard">Filtrar</button>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Top 10 Fazendas com Maior Índice</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoTop10FazendasBroca"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoTop10FazendasBroca"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Evolução Mensal do Índice</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoBrocaMensal"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoBrocaMensal"></canvas>
                        </div>
                        <div class="chart-card">
                           <div class="chart-header">
                                <h3 class="chart-title">Posição da Broca</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoBrocaPosicao"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoBrocaPosicao"></canvas>
                        </div>
                        <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Índice por Variedade</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoBrocaPorVariedade"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoBrocaPorVariedade"></canvas>
                        </div>
                    </div>
                </div>

                <div id="dashboard-perda" style="display: none;" class="dashboard-view">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-dollar-sign"></i> Dashboard de Perdas</h2>
                        <button class="btn-back-to-selector" id="btn-back-to-selector-perda"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                     <div class="filters">
                        <input type="date" id="perdaDashboardInicio">
                        <input type="date" id="perdaDashboardFim">
                        <button id="btnFiltrarPerdaDashboard">Filtrar</button>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Perda Média por Frente e Turno</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoPerdaPorFrenteTurno"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoPerdaPorFrenteTurno"></canvas>
                        </div>
                        <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Composição da Perda por Frente</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoComposicaoPerda"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoComposicaoPerda"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Top 10 Fazendas com Maior Perda</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoTop10FazendasPerda"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoTop10FazendasPerda"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Perda Média por Frente</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoPerdaPorFrente"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoPerdaPorFrente"></canvas>
                        </div>
                    </div>
                </div>

                 <div id="dashboard-aerea" style="display: none;" class="dashboard-view">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-satellite-dish"></i> Dashboard de Monitoramento Aéreo</h2>
                        <button class="btn-back-to-selector" id="btn-back-to-selector-aerea"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                     <div class="filters">
                        <input type="date" id="aereoDashboardInicio">
                        <input type="date" id="aereoDashboardFim">
                        <button id="btnFiltrarAereoDashboard">Filtrar</button>
                    </div>
                     <div class="kpi-grid">
                        <div class="kpi-card"><h4>Fazendas Monitoradas</h4><p id="kpi-aereo-fazendas-monitoradas">0</p></div>
                        <div class="kpi-card"><h4>% Fazendas em Risco</h4><p id="kpi-aereo-fazendas-risco">0%</p></div>
                        <div class="kpi-card"><h4>Infestação Média</h4><p id="kpi-aereo-infestacao-media">0.0</p></div>
                        <div class="kpi-card"><h4>Custo Total de Controle</h4><p id="kpi-aereo-custo-total">R$ 0,00</p></div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Proporção de Fazendas em Risco</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoFazendasRisco"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoFazendasRisco"></canvas>
                        </div>
                        <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Nível de Risco por Fazenda</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoRiscoPorFazenda"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoRiscoPorFazenda"></canvas>
                        </div>
                         <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Tendência da Infestação Média</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoTendenciaAerea"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoTendenciaAerea"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Análise de Custo (Exemplo)</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoCustoAereo"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoCustoAereo"></canvas>
                        </div>
                    </div>
                </div>

                <div id="dashboard-plantio" style="display: none;" class="dashboard-view">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-seedling"></i> Dashboard de Plantio</h2>
                        <button class="btn-back-to-selector" id="btn-back-to-selector-plantio"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="filters">
                        <input type="date" id="plantioDashboardInicio">
                        <input type="date" id="plantioDashboardFim">
                        <select id="plantioDashboardCultura">
                            <option value="">Todas as Culturas</option>
                            <option value="Cana-de-Açúcar">Cana-de-Açúcar</option>
                            <option value="Soja">Soja</option>
                            <option value="Milho">Milho</option>
                            <option value="Algodão">Algodão</option>
                            <option value="Sorgo">Sorgo</option>
                        </select>
                        <button id="btnFiltrarPlantioDashboard">Filtrar</button>
                    </div>
                    <div class="kpi-grid-5">
                        <div class="kpi-card"><h4>Área Total Plantada</h4><p id="kpi-plantio-area-total">0 ha</p></div>
                        <div class="kpi-card"><h4>Meta Total</h4><p id="kpi-plantio-meta">0 ha</p></div>
                        <div class="kpi-card"><h4>% Concluído</h4><p id="kpi-plantio-percentual">0%</p></div>
                        <div class="kpi-card"><h4>Média Diária Real</h4><p id="kpi-plantio-media-diaria">0 ha/dia</p></div>
                        <div class="kpi-card"><h4>Área Restante</h4><p id="kpi-plantio-area-restante">0 ha</p></div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Evolução Acumulada da Área Plantada</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoEvolucaoAreaPlantada"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoEvolucaoAreaPlantada"></canvas>
                        </div>
                        <div class="chart-card">
                             <div class="chart-header">
                                <h3 class="chart-title">Conclusão da Meta Total</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoConclusaoPlantio"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoConclusaoPlantio"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Área Plantada por Mês</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoAreaPlantadaPorDia"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoAreaPlantadaPorDia"></canvas>
                        </div>
                         <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Produtividade por Frente</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoProdutividadePorFrente"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoProdutividadePorFrente"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Média de Chuva por Fazenda</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoChuvaPorFazenda"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoChuvaPorFazenda"></canvas>
                        </div>
                    </div>
                </div>

                <div id="dashboard-cigarrinha" style="display: none;" class="dashboard-view">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-leaf"></i> Dashboard de Cigarrinha</h2>
                        <button class="btn-back-to-selector" id="btn-back-to-selector-cigarrinha"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="filters">
                        <input type="date" id="cigarrinhaDashboardInicio">
                        <input type="date" id="cigarrinhaDashboardFim">
                        <button id="btnFiltrarCigarrinhaDashboard">Filtrar</button>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card"><h4>Infestação Média Geral</h4><p id="kpi-cigarrinha-infestacao-media">0.00</p></div>
                        <div class="kpi-card"><h4>Total de Talhões Avaliados</h4><p id="kpi-cigarrinha-talhoes-avaliados">0</p></div>
                        <div class="kpi-card"><h4>Eficiência de Controle</h4><p id="kpi-cigarrinha-eficiencia-controle">N/A</p></div>
                        <div class="kpi-card"><h4>Talhões em Nível de Alerta</h4><p id="kpi-cigarrinha-talhoes-alerta">0</p></div>
                    </div>
                    <div class="dashboard-grid">
                         <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Top 15 Talhões com Maior Infestação</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoInfestacaoMediaTalhao"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoInfestacaoMediaTalhao"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Distribuição por Nível de Infestação</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoNivelInfestacao"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoNivelInfestacao"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Tendência da Infestação Média</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoTendenciaCigarrinha"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoTendenciaCigarrinha"></canvas>
                        </div>
                         <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Eficiência de Controle (Exemplo)</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoEficienciaControle"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoEficienciaControle"></canvas>
                        </div>
                    </div>
                </div>

                 <div id="dashboard-clima" style="display: none;" class="dashboard-view">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-cloud-sun-rain"></i> Dashboard Climatológico</h2>
                        <button class="btn-back-to-selector" id="btn-back-to-selector-clima"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="filters">
                        <input type="date" id="climaDashboardInicio">
                        <input type="date" id="climaDashboardFim">
                        <select id="climaDashboardFazenda"></select>
                        <button id="btnFiltrarClimaDashboard">Filtrar</button>
                    </div>
                    <div class="kpi-grid-5">
                        <div class="kpi-card"><h4>Temp. Máx. Média</h4><p id="kpi-clima-temp-max">0°C</p></div>
                        <div class="kpi-card"><h4>Temp. Mín. Média</h4><p id="kpi-clima-temp-min">0°C</p></div>
                        <div class="kpi-card"><h4>Pluviosidade Total</h4><p id="kpi-clima-pluviosidade">0 mm</p></div>
                        <div class="kpi-card"><h4>Umidade Média</h4><p id="kpi-clima-umidade">0%</p></div>
                        <div class="kpi-card"><h4>Vento Médio</h4><p id="kpi-clima-vento">0 km/h</p></div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card large">
                            <div class="chart-header">
                                <h3 class="chart-title">Variação de Temperatura Diária</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoVariacaoTemperatura"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoVariacaoTemperatura"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Acúmulo de Pluviosidade Diária</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoAcumuloPluviosidade"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoAcumuloPluviosidade"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Velocidade Média do Vento por Fazenda</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoMediaVentoFazenda"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoMediaVentoFazenda"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3 class="chart-title">Índice Climatológico Geral</h3>
                                <button class="btn-expand-chart" data-chart-id="graficoIndiceClimatologico"><i class="fas fa-expand"></i></button>
                            </div>
                            <canvas id="graficoIndiceClimatologico"></canvas>
                        </div>
                    </div>
                </div>

            </div>

            <div id="dashboardClima" class="tab-content" hidden>
                <h2><i class="fas fa-cloud-sun-rain"></i> Dashboard Climatológico</h2>
            </div>

            <div id="monitoramentoAereo" class="tab-content" hidden>
                <div id="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button id="btnAddTrap" title="Instalar Armadilha na Posição Atual"><i class="fas fa-plus"></i></button>
                        <button id="btnCenterMap" title="Centrar no Utilizador"><i class="fas fa-crosshairs"></i></button>
                        <button id="btnHistory" title="Histórico de Rota"><i class="fas fa-history"></i></button>
                        <button id="btnToggleRiskView" title="Visualização de Risco" style="display: none;"><i class="fas fa-shield-alt"></i></button>
                        <div class="map-search-container">
                            <input type="text" id="map-farm-search-input" placeholder="Buscar Fundo Agrícola...">
                            <button id="map-farm-search-btn"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div id="talhao-info-box" class="info-box">
                        <button id="close-info-box" class="close-btn">&times;</button>
                        <div id="talhao-info-box-content"></div>
                    </div>
                    <div id="trap-info-box" class="info-box">
                        <button id="close-trap-info-box" class="close-btn">&times;</button>
                        <div id="trap-info-box-content"></div>
                    </div>
                </div>
            </div>

            <!-- NOVAS ABAS PARA INSTALAÇÃO -->
            <div id="instalacaoPlanejamento" class="tab-content map-view-tab" hidden>
                <div id="planning-map-container">
                    <div id="planning-map"></div>
                    <!-- Controls could be here if they were different from the main map -->
                </div>
            </div>

            <div id="instalacaoOS" class="tab-content" hidden>
                <h2><i class="fas fa-clipboard-list"></i> Gerar Ordem de Serviço</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllPlannedPoints"></th>
                                <th>Fazenda</th>
                                <th>Talhão</th>
                                <th>Data Prevista</th>
                                <th>Responsável</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="plannedPointsTableBody"></tbody>
                    </table>
                </div>
                <div class="form-actions">
                    <button id="btnGenerateOS" class="save">Gerar OS</button>
                </div>
            </div>

            <div id="osExecution" class="tab-content" hidden>
                <h2><i class="fas fa-tasks"></i> Execução de Ordens de Serviço</h2>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Número OS</th>
                                <th>Responsável</th>
                                <th>Prazo</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="osListTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="osDetail" class="tab-content map-view-tab" hidden>
                <div class="os-detail-header">
                    <button id="backToOSListBtn"><i class="fas fa-arrow-left"></i> Voltar</button>
                    <h2 id="osDetailTitle">Detalhes da OS</h2>
                </div>
                <div class="os-detail-container">
                    <div id="osDetailMapContainer">
                        <div id="os-detail-map"></div>
                    </div>
                    <div id="osDetailSidebar">
                        <h3>Pontos de Instalação</h3>
                        <ul id="osDetailPointList"></ul>
                    </div>
                </div>
            </div>

            <div id="planejamento" class="tab-content" hidden>
                <h2><i class="fas fa-calendar-alt"></i> Planeamento de Inspeção</h2>
                <div class="form-container" style="max-width: 800px; margin: 0 auto 20px auto;">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="planoTipo" class="required">Tipo:</label>
                            <select id="planoTipo">
                                <option value="broca">Broca</option>
                                <option value="perda">Perda</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="planoFazenda" class="required">Fazenda:</label>
                            <select id="planoFazenda"></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="planoTalhao" class="required">Talhão:</label>
                            <input type="text" id="planoTalhao" placeholder="Nome do Talhão">
                        </div>
                        <div class="form-col">
                            <label for="planoData" class="required">Data Prevista:</label>
                            <input type="date" id="planoData">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                             <label for="planoResponsavel" class="required">Responsável:</label>
                             <select id="planoResponsavel"></select>
                        </div>
                        <div class="form-col">
                            <label for="planoMeta">Meta (opcional):</label>
                            <input type="text" id="planoMeta" placeholder="Ex: < 5%">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="planoObs">Observações:</label>
                            <textarea id="planoObs" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnAgendarInspecao" class="save"><i class="fas fa-plus"></i> Agendar Inspeção</button>
                        <button id="btnSugerirPlano" class="ai-button"><i class="fas fa-brain"></i> Sugerir Plano (IA)</button>
                    </div>
                </div>
                <div id="listaPlanejamento"></div>
            </div>
            
            <div id="planejamentoColheita" class="tab-content" hidden>
                <div id="harvest-plans-list-container">
                    <h2><i class="fas fa-stream"></i> Planos de Colheita</h2>
                    <div class="form-actions" style="justify-content: flex-end;">
                        <button id="btnAddNewHarvestPlan" class="save"><i class="fas fa-plus"></i> Novo Plano</button>
                    </div>
                    <div id="harvest-plans-list"></div>
                </div>

                <div id="harvest-plan-editor" style="display: none;">
                    <div class="form-container">
                        <h2><i class="fas fa-edit"></i> Editor de Plano de Colheita</h2>
                        <div class="form-row">
                             <div class="form-col" id="superAdminHarvestCreation" style="display:none;">
                                <label for="adminTargetCompanyHarvest" class="required">Empresa Alvo:</label>
                                <select id="adminTargetCompanyHarvest"></select>
                            </div>
                            <div class="form-col">
                                <label for="harvestFrontName" class="required">Nome da Frente:</label>
                                <input type="text" id="harvestFrontName" placeholder="Ex: Frente 1">
                            </div>
                             <div class="form-col">
                                <label for="harvestStartDate" class="required">Data de Início:</label>
                                <input type="date" id="harvestStartDate">
                            </div>
                            <div class="form-col">
                                <label for="harvestDailyRate" class="required">Taxa Diária (ton/dia):</label>
                                <input type="number" id="harvestDailyRate" value="750">
                            </div>
                        </div>
                        <div class="form-actions" style="margin-bottom: 20px; justify-content: flex-end;">
                            <button id="btnCancelPlan" class="btn-secondary">Voltar à Lista</button>
                            <button id="btnSavePlan" class="save"><i class="fas fa-save"></i> Guardar Plano</button>
                        </div>
                    </div>

                    <div class="form-container" style="margin-top:20px;">
                        <h3 id="addOrEditSequenceTitle"><i class="fas fa-plus-circle"></i> Adicionar Fazenda à Sequência</h3>
                        <input type="hidden" id="editingGroupId">
                         <div class="form-row">
                            <div class="form-col">
                                <label for="harvestFazenda" class="required">Fazenda:</label>
                                <select id="harvestFazenda"></select>
                            </div>
                             <div class="form-col">
                                <label for="harvestAtr" class="required">ATR Previsto:</label>
                                <div class="input-with-spinner">
                                    <input type="number" id="harvestAtr" placeholder="ATR Previsto">
                                    <div class="spinner" id="atr-spinner" style="display: none;"></div>
                                </div>
                            </div>
                         </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="harvestMaturador">Maturador Aplicado:</label>
                                <input type="text" id="harvestMaturador" placeholder="Nome do Produto">
                            </div>
                            <div class="form-col">
                                <label for="harvestMaturadorDate">Data de Aplicação:</label>
                                <input type="date" id="harvestMaturadorDate">
                            </div>
                        </div>
                        <h4>Talhões Disponíveis na Fazenda</h4>
                        <label class="report-option-item">
                            <input type="checkbox" id="selectAllTalhoes">
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content">
                                <span><strong>Selecionar Todos os Talhões Disponíveis</strong></span>
                            </span>
                        </label>
                        <div id="harvestTalhaoSelectionList"></div>

                        <div class="form-actions" style="margin-top:20px;">
                            <button id="btnCancelEditSequence" class="btn-secondary" style="display: none;">Cancelar Edição</button>
                            <button id="btnAddOrUpdateHarvestSequence" class="save"><i class="fas fa-plus"></i> Adicionar à Sequência</button>
                        </div>
                    </div>

                    <div style="margin-top:30px;">
                        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3><i class="fas fa-tasks"></i> Sequência de Colheita</h3>
                            <button id="btnOptimizeHarvest" class="ai-button"></button>
                        </div>
                        <div class="table-container">
                            <table class="harvestPlanTable" id="harvestPlanTable">
                                <thead>
                                    <tr>
                                        <th>Seq.</th>
                                        <th>Fazenda</th>
                                        <th>Talhões</th>
                                        <th>Área (ha)</th>
                                        <th>Prod. (ton)</th>
                                        <th>ATR</th>
                                        <th>Idade (m)</th>
                                        <th>Maturador</th>
                                        <th>Dias Aplic.</th>
                                        <th>Ação</th>
                                        <th>Entrada</th>
                                        <th>Saída</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                         <div id="harvestSummary"></div>
                    </div>
                </div>
            </div>

            <div id="lancamentoBroca" class="tab-content" hidden>
                <h2><i class="fas fa-bug"></i> Lançamento de Broca</h2>
                <form id="lancamentoBroca" class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="codigo" class="required">Código da Fazenda:</label>
                            <select id="codigo" required></select>
                        </div>
                        <div class="form-col">
                            <label for="data" class="required">Data da Inspeção:</label>
                            <input type="date" id="data" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="talhao" class="required">Talhão:</label>
                            <input type="text" id="talhao" placeholder="Nome do Talhão" required style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                            <div id="varietyDisplay" class="info-display"></div>
                        </div>
                        <div class="form-col">
                            <label for="entrenos" class="required">Total de Entrenós:</label>
                            <input type="number" id="entrenos" required>
                        </div>
                    </div>
                    <fieldset>
                        <legend>Entrenós Brocados</legend>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="brocaBase">Base:</label>
                                <input type="number" id="brocaBase" value="0">
                            </div>
                            <div class="form-col">
                                <label for="brocaMeio">Meio:</label>
                                <input type="number" id="brocaMeio" value="0">
                            </div>
                            <div class="form-col">
                                <label for="brocaTopo">Topo:</label>
                                <input type="number" id="brocaTopo" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="brocado">Total Brocado:</label>
                                <input type="number" id="brocado" readonly>
                            </div>
                        </div>
                    </fieldset>
                    <div class="resultado" id="resultado"></div>
                    <div class="form-actions">
                        <button type="button" id="btnSalvarBrocamento" class="save"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                </form>
            </div>
            
            <div id="lancamentoPerda" class="tab-content" hidden>
                 <h2><i class="fas fa-dollar-sign"></i> Lançamento de Perda</h2>
                <form id="lancamentoPerda" class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="dataPerda" class="required">Data da Inspeção:</label>
                            <input type="date" id="dataPerda" required>
                        </div>
                        <div class="form-col">
                            <label for="codigoPerda" class="required">Código da Fazenda:</label>
                            <select id="codigoPerda" required></select>
                        </div>
                    </div>
                     <div class="form-row">
                         <div class="form-col">
                            <label for="talhaoPerda" class="required">Talhão:</label>
                            <input type="text" id="talhaoPerda" placeholder="Nome do Talhão" required style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                            <div id="varietyDisplayPerda" class="info-display"></div>
                        </div>
                        <div class="form-col">
                            <label for="frenteServico" class="required">Frente de Serviço:</label>
                            <input type="text" id="frenteServico" required>
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-col">
                            <label for="turno" class="required">Turno:</label>
                            <select id="turno" required>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="frotaEquipamento" class="required">Frota do Equipamento:</label>
                            <input type="text" id="frotaEquipamento" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="matriculaOperador" class="required">Matrícula do Operador:</label>
                            <input type="text" id="matriculaOperador" required>
                            <div id="operadorNome" class="info-display"></div>
                        </div>
                    </div>
                    <fieldset>
                        <legend>Tipos de Perda (kg)</legend>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="canaInteira">Cana Inteira:</label>
                                <input type="number" step="0.01" id="canaInteira" value="0">
                            </div>
                            <div class="form-col">
                                <label for="tolete">Tolete:</label>
                                <input type="number" step="0.01" id="tolete" value="0">
                            </div>
                            <div class="form-col">
                                <label for="toco">Toco:</label>
                                <input type="number" step="0.01" id="toco" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="ponta">Ponta:</label>
                                <input type="number" step="0.01" id="ponta" value="0">
                            </div>
                            <div class="form-col">
                                <label for="estilhaco">Estilhaço:</label>
                                <input type="number" step="0.01" id="estilhaco" value="0">
                            </div>
                             <div class="form-col">
                                <label for="pedaco">Pedaço:</label>
                                <input type="number" step="0.01" id="pedaco" value="0">
                            </div>
                        </div>
                    </fieldset>
                    <div class="resultado" id="resultadoPerda"></div>
                    <div class="form-actions">
                        <button type="button" id="btnSalvarPerda" class="save"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                </form>
            </div>

            <div id="lancamentoCigarrinha" class="tab-content" hidden>
                <h2><i class="fas fa-leaf"></i> Monitoramento de Cigarrinha (Ponto Fixo)</h2>
                <form id="lancamentoCigarrinha" class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="dataCigarrinha" class="required">Data:</label>
                            <input type="date" id="dataCigarrinha" required>
                        </div>
                        <div class="form-col">
                            <label for="codigoCigarrinha" class="required">Fazenda:</label>
                            <select id="codigoCigarrinha" required></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="talhaoCigarrinha" class="required">Talhão:</label>
                            <input type="text" id="talhaoCigarrinha" required style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                            <div id="varietyDisplayCigarrinha" class="info-display"></div>
                        </div>
                    </div>
                     <fieldset>
                        <legend>Fases da Cigarrinha</legend>
                        <div class="form-row">
                             ${[1, 2, 3, 4, 5].map(i => `
                                <div class="form-col">
                                    <label for="fase${i}Cigarrinha">Fase ${i}:</label>
                                    <input type="number" id="fase${i}Cigarrinha" value="0" min="0">
                                </div>
                            `).join('')}
                        </div>
                    </fieldset>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="checkbox-container">Adulto Presente
                                <input type="checkbox" id="adultoPresenteCigarrinha">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </div>
                    <div class="resultado" id="resultadoCigarrinha"></div>
                    <div class="form-actions">
                        <button type="button" id="btnSalvarCigarrinha" class="save"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                </form>
            </div>

            <div id="lancamentoCigarrinhaAmostragem" class="tab-content" hidden>
                <h2><i class="fas fa-vial"></i> Monitoramento de Cigarrinha (Amostragem)</h2>
                <form id="formCigarrinhaAmostragem" class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="dataCigarrinhaAmostragem" class="required">Data:</label>
                            <input type="date" id="dataCigarrinhaAmostragem" required>
                        </div>
                        <div class="form-col">
                            <label for="codigoCigarrinhaAmostragem" class="required">Fazenda:</label>
                            <select id="codigoCigarrinhaAmostragem" required></select>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-col">
                            <label for="talhaoCigarrinhaAmostragem" class="required">Talhão:</label>
                            <input type="text" id="talhaoCigarrinhaAmostragem" required style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                             <div id="varietyDisplayCigarrinhaAmostragem" class="info-display"></div>
                        </div>
                    </div>
                    <fieldset>
                        <legend>Sub-Amostras</legend>
                        <div id="amostrasCigarrinhaAmostragemContainer"></div>
                        <button type="button" id="addAmostraCigarrinhaAmostragem" class="add-amostra-btn"><i class="fas fa-plus"></i> Adicionar Amostra</button>
                    </fieldset>
                    <div class="form-row">
                        <div class="form-col">
                            <label class="checkbox-container">Adulto Presente
                                <input type="checkbox" id="adultoPresenteCigarrinhaAmostragem">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </div>
                    <div class="resultado" id="resultadoCigarrinhaAmostragem"></div>
                     <div class="form-actions">
                        <button type="button" id="btnSalvarCigarrinhaAmostragem" class="save"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                </form>
            </div>

            <div id="apontamentoPlantio" class="tab-content" hidden>
                <h2><i class="fas fa-seedling"></i> Apontamento de Plantio</h2>
                <form id="formApontamentoPlantio" class="form-container">
                    <input type="hidden" id="plantioEntryId">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="plantioFrente" class="required">Frente de Plantio:</label>
                            <select id="plantioFrente" required></select>
                        </div>
                        <div class="form-col">
                            <label for="plantioProvider">Prestador Vinculado:</label>
                            <input type="text" id="plantioProvider" readonly>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-col">
                            <label for="plantioCulture" class="required">Cultura:</label>
                            <select id="plantioCulture" required>
                                <option value="Cana-de-Açúcar">Cana-de-Açúcar</option>
                                <option value="Soja">Soja</option>
                                <option value="Milho">Milho</option>
                                <option value="Algodão">Algodão</option>
                                <option value="Sorgo">Sorgo</option>
                            </select>
                        </div>
                        <div class="form-col">
                             <label for="plantioLeaderId" class="required">Matrícula do Líder:</label>
                            <input type="text" id="plantioLeaderId" required>
                            <div id="plantioLeaderName" class="info-display"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="plantioFarmName" class="required">Fazenda:</label>
                            <select id="plantioFarmName" required></select>
                        </div>
                         <div class="form-col">
                            <label for="plantioDate" class="required">Data:</label>
                            <input type="date" id="plantioDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="plantioChuva">Chuva (mm):</label>
                            <input type="number" id="plantioChuva" placeholder="Ex: 15.5">
                        </div>
                        <div class="form-col">
                            <label for="plantioObs">Observações:</label>
                            <input type="text" id="plantioObs">
                        </div>
                    </div>
                     <fieldset>
                        <legend>Lançamentos</legend>
                        <div id="plantioInfo" class="info-display" style="text-align: center; margin-bottom: 15px; font-weight: 500;"></div>
                        <div id="plantioRecordsContainer"></div>
                        <button type="button" id="addPlantioRecord" class="add-amostra-btn"><i class="fas fa-plus"></i> Adicionar Lançamento</button>
                    </fieldset>
                    <div class="resultado" id="totalPlantedArea" style="font-size: 1.2em; text-align: right; margin-top: 10px;">Total de Área Plantada: 0,00 ha</div>
                    <div class="form-actions">
                        <button type="button" id="btnSaveApontamentoPlantio" class="save"><i class="fas fa-save"></i> Guardar Apontamento</button>
                    </div>
                </form>
            </div>

             <div id="lancamentoClima" class="tab-content" hidden>
                <h2><i class="fas fa-cloud"></i> Apontamento Climatológico</h2>
                <form id="formLancamentoClima" class="form-container">
                    <input type="hidden" id="climaEntryId">
                     <div class="form-row">
                        <div class="form-col">
                            <label for="climaData" class="required">Data:</label>
                            <input type="date" id="climaData" required>
                        </div>
                        <div class="form-col">
                            <label for="climaFazenda" class="required">Fazenda:</label>
                            <select id="climaFazenda" required></select>
                        </div>
                        <div class="form-col">
                            <label for="climaTalhao" class="required">Talhão:</label>
                            <select id="climaTalhao" required></select>
                        </div>
                    </div>
                    <fieldset>
                        <legend>Condições Climáticas</legend>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="climaTempMax" class="required">Temp. Máxima (°C):</label>
                                <input type="number" step="0.1" id="climaTempMax" required>
                            </div>
                            <div class="form-col">
                                <label for="climaTempMin" class="required">Temp. Mínima (°C):</label>
                                <input type="number" step="0.1" id="climaTempMin" required>
                            </div>
                            <div class="form-col">
                                <label for="climaUmidade" class="required">Umidade Relativa (%):</label>
                                <input type="number" step="0.1" id="climaUmidade" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="climaPluviosidade" class="required">Pluviosidade (mm):</label>
                                <input type="number" step="0.1" id="climaPluviosidade" required>
                            </div>
                            <div class="form-col">
                                <label for="climaVento" class="required">Velocidade do Vento (km/h):</label>
                                <input type="number" step="0.1" id="climaVento" required>
                            </div>
                        </div>
                    </fieldset>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="climaObs">Observações:</label>
                            <textarea id="climaObs" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="btnSaveLancamentoClima" class="save"><i class="fas fa-save"></i> Guardar Apontamento</button>
                    </div>
                </form>
            </div>

            <div id="relatorioBroca" class="tab-content" hidden>
                <h2><i class="fas fa-chart-bar"></i> Relatório de Broca</h2>
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="inicioBrocamento" class="required">Data Início:</label>
                            <input type="date" id="inicioBrocamento">
                        </div>
                        <div class="form-col">
                            <label for="fimBrocamento" class="required">Data Fim:</label>
                            <input type="date" id="fimBrocamento">
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-col">
                            <label for="fazendaFiltroBrocamento">Fazenda:</label>
                            <select id="fazendaFiltroBrocamento"></select>
                        </div>
                        <div class="form-col">
                             <label for="tipoRelatorioBroca">Agrupar por:</label>
                            <select id="tipoRelatorioBroca">
                                <option value="fazenda">Fazenda</option>
                                <option value="talhao">Talhão</option>
                                <option value="variedade">Variedade</option>
                                <option value="data">Data</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Filtrar por Tipo de Fazenda:</label>
                            <div class="checkbox-group" id="brocaReportFarmTypeFilter">
                                <label class="checkbox-container">Própria <input type="checkbox" value="Própria"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Parceira <input type="checkbox" value="Parceira"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Arrendada <input type="checkbox" value="Arrendada"><span class="checkmark"></span></label>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnPDFBrocamento" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button id="btnExcelBrocamento" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </div>

            <div id="relatorioPerda" class="tab-content" hidden>
                <h2><i class="fas fa-chart-pie"></i> Relatório de Perda</h2>
                 <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="inicioPerda" class="required">Data Início:</label>
                            <input type="date" id="inicioPerda">
                        </div>
                        <div class="form-col">
                            <label for="fimPerda" class="required">Data Fim:</label>
                            <input type="date" id="fimPerda">
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-col">
                            <label for="fazendaFiltroPerda">Fazenda:</label>
                            <select id="fazendaFiltroPerda"></select>
                        </div>
                        <div class="form-col">
                            <label for="talhaoFiltroPerda">Talhão:</label>
                            <input type="text" id="talhaoFiltroPerda">
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-col">
                            <label for="operadorFiltroPerda">Operador:</label>
                            <select id="operadorFiltroPerda"></select>
                        </div>
                        <div class="form-col">
                            <label for="frenteFiltroPerda">Frente de Serviço:</label>
                            <input type="text" id="frenteFiltroPerda">
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-col">
                             <label for="tipoRelatorioPerda">Agrupar por:</label>
                            <select id="tipoRelatorioPerda">
                                <option value="fazenda">Fazenda</option>
                                <option value="frente">Frente de Serviço</option>
                                <option value="operador">Operador</option>
                                <option value="data">Data</option>
                            </select>
                        </div>
                     </div>
                     <div class="form-row">
                        <div class="form-col">
                            <label>Filtrar por Tipo de Fazenda:</label>
                            <div class="checkbox-group" id="perdaReportFarmTypeFilter">
                                <label class="checkbox-container">Própria <input type="checkbox" value="Própria"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Parceira <input type="checkbox" value="Parceira"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Arrendada <input type="checkbox" value="Arrendada"><span class="checkmark"></span></label>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnPDFPerda" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button id="btnExcelPerda" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </div>

            <div id="relatorioCigarrinha" class="tab-content" hidden>
                <h2><i class="fas fa-leaf"></i> Relatório de Cigarrinha</h2>
                 <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="inicioCigarrinha" class="required">Data Início:</label>
                            <input type="date" id="inicioCigarrinha">
                        </div>
                        <div class="form-col">
                            <label for="fimCigarrinha" class="required">Data Fim:</label>
                            <input type="date" id="fimCigarrinha">
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-col">
                            <label for="fazendaFiltroCigarrinha">Fazenda:</label>
                            <select id="fazendaFiltroCigarrinha"></select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnPDFCigarrinha" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button id="btnExcelCigarrinha" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </div>

            <div id="relatorioCigarrinhaAmostragem" class="tab-content" hidden>
                <h2><i class="fas fa-file-invoice"></i> Relatório de Cigarrinha (Amostragem)</h2>
                 <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="inicioCigarrinhaAmostragem" class="required">Data Início:</label>
                            <input type="date" id="inicioCigarrinhaAmostragem">
                        </div>
                        <div class="form-col">
                            <label for="fimCigarrinhaAmostragem" class="required">Data Fim:</label>
                            <input type="date" id="fimCigarrinhaAmostragem">
                        </div>
                    </div>
                     <div class="form-row">
                         <div class="form-col">
                            <label for="fazendaFiltroCigarrinhaAmostragem">Fazenda:</label>
                            <select id="fazendaFiltroCigarrinhaAmostragem"></select>
                        </div>
                         <div class="form-col">
                            <label for="tipoRelatorioCigarrinhaAmostragem">Agrupar por:</label>
                            <select id="tipoRelatorioCigarrinhaAmostragem">
                                <option value="fazenda">Fazenda</option>
                                <option value="talhao">Talhão</option>
                                <option value="variedade">Variedade</option>
                                <option value="data">Data</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnPDFCigarrinhaAmostragem" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button id="btnExcelCigarrinhaAmostragem" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </div>

            <div id="relatorioColheitaCustom" class="tab-content" hidden>
                <h2><i class="fas fa-file-invoice"></i> Relatório Customizado de Colheita</h2>
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="planoRelatorioSelect" class="required">Selecione o Plano de Colheita:</label>
                            <select id="planoRelatorioSelect"></select>
                        </div>
                        <div class="form-col">
                            <label for="tipoRelatorioColheita" class="required">Tipo de Relatório:</label>
                             <select id="tipoRelatorioColheita">
                                <option value="mensal">Resumo Mensal</option>
                                <option value="detalhado">Detalhado por Fazenda</option>
                            </select>
                        </div>
                    </div>
                    <div id="reportOptionsContainer">
                        <div id="colunas-detalhado-container" style="display: none;">
                            <label>Selecione as colunas para o relatório detalhado:</label>
                             <div class="report-options-grid">
                                <label class="report-option-item"><input type="checkbox" data-column="atr" checked><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content"><i class="fas fa-candy-cane"></i><span>ATR</span></span></label>
                                <label class="report-option-item"><input type="checkbox" data-column="idade" checked><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content"><i class="fas fa-hourglass-half"></i><span>Idade Média</span></span></label>
                                <label class="report-option-item"><input type="checkbox" data-column="variedade" checked><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content"><i class="fas fa-seedling"></i><span>Variedades</span></span></label>
                                <label class="report-option-item"><input type="checkbox" data-column="maturador"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content"><i class="fas fa-vial"></i><span>Maturador</span></span></label>
                                <label class="report-option-item"><input type="checkbox" data-column="diasAplicacao"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content"><i class="fas fa-calendar-alt"></i><span>Dias de Aplicação</span></span></label>
                                <label class="report-option-item"><input type="checkbox" data-column="datas" checked><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content"><i class="fas fa-calendar-week"></i><span>Datas Entrada/Saída</span></span></label>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnGerarRelatorioCustomPDF" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button id="btnGerarRelatorioCustomExcel" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </div>

            <div id="relatorioMonitoramento" class="tab-content" hidden>
                <h2><i class="fas fa-map-marked-alt"></i> Relatório de Monitoramento de Armadilhas</h2>
                 <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="monitoramentoTipoRelatorio">Tipo de Relatório:</label>
                            <select id="monitoramentoTipoRelatorio">
                                <option value="coletadas">Armadilhas Coletadas</option>
                                <option value="ativas">Armadilhas Instaladas/Ativas</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="monitoramentoInicio" class="required">Data Início:</label>
                            <input type="date" id="monitoramentoInicio">
                        </div>
                        <div class="form-col">
                            <label for="monitoramentoFim" class="required">Data Fim:</label>
                            <input type="date" id="monitoramentoFim">
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-col">
                            <label for="monitoramentoFazendaFiltro">Fazenda:</label>
                            <select id="monitoramentoFazendaFiltro"></select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnPDFMonitoramento" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button id="btnExcelMonitoramento" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </div>

            <div id="relatorioRisco" class="tab-content" hidden>
                <h2><i class="fas fa-shield-alt"></i> Relatório de Risco</h2>
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="riscoRelatorioInicio" class="required">Data Início:</label>
                            <input type="date" id="riscoRelatorioInicio">
                        </div>
                        <div class="form-col">
                            <label for="riscoRelatorioFim" class="required">Data Fim:</label>
                            <input type="date" id="riscoRelatorioFim">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                             <label class="checkbox-container">Incluir apenas fazendas com risco >= 30%
                                <input type="checkbox" id="riskOnlyCheckbox">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnPDFRisco" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button id="btnExcelRisco" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </div>

             <div id="relatorioPlantio" class="tab-content" hidden>
                <h2><i class="fas fa-chart-bar"></i> Relatórios de Plantio</h2>
                <form id="formRelatorioPlantio" class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="plantioRelatorioInicio" class="required">Data Início:</label>
                            <input type="date" id="plantioRelatorioInicio">
                        </div>
                        <div class="form-col">
                            <label for="plantioRelatorioFim" class="required">Data Fim:</label>
                            <input type="date" id="plantioRelatorioFim">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="plantioRelatorioFrente">Frente de Plantio:</label>
                            <select id="plantioRelatorioFrente"></select>
                        </div>
                        <div class="form-col">
                            <label for="plantioRelatorioCultura">Cultura:</label>
                            <select id="plantioRelatorioCultura">
                                <option value="">Todas</option>
                                <option value="Cana-de-Açúcar">Cana-de-Açúcar</option>
                                <option value="Soja">Soja</option>
                                <option value="Milho">Milho</option>
                                <option value="Algodão">Algodão</option>
                                <option value="Sorgo">Sorgo</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-col">
                            <label>Filtrar por Tipo de Fazenda:</label>
                            <div class="checkbox-group" id="plantioReportFarmTypeFilter">
                                <label class="checkbox-container">Própria <input type="checkbox" value="Própria"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Parceira <input type="checkbox" value="Parceira"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Arrendada <input type="checkbox" value="Arrendada"><span class="checkmark"></span></label>
                            </div>
                        </div>
                        <div class="form-col">
                             <label for="tipoRelatorioPlantio">Agrupar por:</label>
                            <select id="tipoRelatorioPlantio">
                                <option value="fazenda">Fazenda</option>
                                <option value="talhao">Talhão</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="btnPDFPlantio" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button type="button" id="btnExcelPlantio" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </form>
            </div>

            <div id="relatorioClima" class="tab-content" hidden>
                <h2><i class="fas fa-file-pdf"></i> Relatório Climatológico</h2>
                <form id="formRelatorioClima" class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="climaRelatorioInicio" class="required">Data Início:</label>
                            <input type="date" id="climaRelatorioInicio">
                        </div>
                        <div class="form-col">
                            <label for="climaRelatorioFim" class="required">Data Fim:</label>
                            <input type="date" id="climaRelatorioFim">
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-col">
                            <label for="climaRelatorioFazenda">Fazenda:</label>
                            <select id="climaRelatorioFazenda">
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" id="btnPDFClima" class="save"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
                        <button type="button" id="btnExcelClima" class="excel-button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </form>
            </div>

            <div id="frenteDePlantio" class="tab-content" hidden>
                <h2><i class="fas fa-tractor"></i> Frentes de Plantio</h2>
                <div class="form-container" style="max-width: 800px; margin: 0 auto 20px auto;">
                    <input type="hidden" id="frenteDePlantioId">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="frenteDePlantioName" class="required">Nome da Frente:</label>
                            <input type="text" id="frenteDePlantioName" required style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                        </div>
                        <div class="form-col">
                            <label for="frenteDePlantioProvider" class="required">Prestador Vinculado:</label>
                            <input type="text" id="frenteDePlantioProvider" required style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                             <label for="frenteDePlantioObs">Observação:</label>
                            <input type="text" id="frenteDePlantioObs">
                        </div>
                    </div>
                     <div class="form-actions">
                        <button id="btnSaveFrenteDePlantio" class="save"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                </div>
                <div id="frenteDePlantioList"></div>
            </div>

            <div id="cadastros" class="tab-content" hidden>
                <h2><i class="fas fa-book"></i> Cadastro de Fazendas e Talhões</h2>
                <div class="form-container" style="max-width: 800px; margin: 0 auto 20px auto;">
                    <h3><i class="fas fa-tractor"></i> Nova Fazenda</h3>
                    <div id="superAdminFarmCreation" style="display:none;">
                         <label for="adminTargetCompanyFarms" class="required">Empresa Alvo:</label>
                         <select id="adminTargetCompanyFarms"></select>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="farmCode" class="required">Código:</label>
                            <input type="text" id="farmCode" placeholder="Ex: 4001">
                        </div>
                        <div class="form-col">
                            <label for="farmName" class="required">Nome da Fazenda:</label>
                            <input type="text" id="farmName" placeholder="Ex: SANTA RITA" style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-col">
                            <label>Tipo:</label>
                            <div class="checkbox-group" id="farmTypeCheckboxes">
                                <label class="checkbox-container">Própria <input type="checkbox" value="Própria"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Parceira <input type="checkbox" value="Parceira"><span class="checkmark"></span></label>
                                <label class="checkbox-container">Arrendada <input type="checkbox" value="Arrendada"><span class="checkmark"></span></label>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnSaveFarm" class="save"><i class="fas fa-plus"></i> Adicionar Fazenda</button>
                    </div>
                </div>

                <div class="form-container" style="max-width: 1000px; margin: 20px auto;">
                     <h3><i class="fas fa-th-large"></i> Gerir Talhões</h3>
                     <div class="form-row">
                        <div class="form-col">
                            <label for="farmSelect" class="required">Selecione uma Fazenda:</label>
                            <select id="farmSelect"></select>
                        </div>
                     </div>
                     <div id="talhaoManagementContainer" style="display:none;">
                         <h3 id="selectedFarmName"></h3>
                         <span id="selectedFarmTypes"></span>
                         <input type="hidden" id="talhaoId">
                         <div class="form-row">
                             <div class="form-col">
                                 <label for="talhaoName" class="required">Nome do Talhão:</label>
                                 <input type="text" id="talhaoName" placeholder="Ex: T-01" style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
                             </div>
                             <div class="form-col">
                                 <label for="talhaoArea" class="required">Área (ha):</label>
                                 <input type="number" step="0.01" id="talhaoArea" placeholder="Ex: 50.25">
                             </div>
                             <div class="form-col">
                                 <label for="talhaoTCH" class="required">TCH:</label>
                                 <input type="number" step="0.01" id="talhaoTCH" placeholder="Ex: 80.5">
                             </div>
                         </div>
                         <div class="form-row">
                             <div class="form-col">
                                 <label for="talhaoProducao">Produção (ton):</label>
                                 <input type="number" id="talhaoProducao" readonly>
                             </div>
                             <div class="form-col">
                                 <label for="talhaoVariedade">Variedade:</label>
                                 <input type="text" id="talhaoVariedade" placeholder="Ex: RB867515">
                             </div>
                             <div class="form-col">
                                 <label for="talhaoCorte">Corte:</label>
                                 <input type="number" id="talhaoCorte" placeholder="Ex: 2">
                             </div>
                         </div>
                         <div class="form-row">
                            <div class="form-col">
                                <label for="talhaoDistancia">Distância (km):</label>
                                <input type="number" step="0.1" id="talhaoDistancia" placeholder="Ex: 15.5">
                            </div>
                            <div class="form-col">
                                <label for="talhaoUltimaColheita">Data da Última Colheita:</label>
                                <input type="date" id="talhaoUltimaColheita">
                            </div>
                         </div>
                         <div class="form-actions">
                            <button id="btnSaveTalhao" class="save"><i class="fas fa-save"></i> Guardar Talhão</button>
                         </div>
                         <div id="talhaoList"></div>
                     </div>
                </div>

                <div class="form-container" style="max-width: 800px; margin: 20px auto;">
                     <h3><i class="fas fa-file-import"></i> Importar em Massa</h3>
                     <div id="csvUploadArea" class="upload-area">
                         <i class="fas fa-upload"></i>
                         <p>Clique ou arraste o seu ficheiro CSV aqui</p>
                         <input type="file" id="csvFileInput" accept=".csv" hidden>
                     </div>
                     <div class="form-actions">
                         <button id="btnDownloadCsvTemplate" class="btn-secondary"><i class="fas fa-download"></i> Baixar Modelo CSV</button>
                         <button id="btnDeleteAllFarms" class="btn-excluir-permanente"><i class="fas fa-skull-crossbones"></i> Excluir Todas as Fazendas</button>
                     </div>
                    <div class="download-progress-container" id="farm-import-progress" style="display: none;">
                        <p class="download-progress-text"></p>
                        <progress class="download-progress-bar" value="0" max="100"></progress>
                    </div>
                </div>
            </div>

            <div id="cadastrarPessoas" class="tab-content" hidden>
                <h2><i class="fas fa-id-card"></i> Cadastro de Pessoas</h2>
                 <div class="form-container" style="max-width: 800px; margin: 0 auto 20px auto;">
                    <h3><i class="fas fa-user-plus"></i> Nova Pessoa</h3>
                     <input type="hidden" id="personnelId">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="personnelMatricula" class="required">Matrícula:</label>
                            <input type="text" id="personnelMatricula" placeholder="Ex: 12345">
                        </div>
                        <div class="form-col">
                            <label for="personnelName" class="required">Nome Completo:</label>
                            <input type="text" id="personnelName" placeholder="Ex: João da Silva">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnSavePersonnel" class="save"><i class="fas fa-save"></i> Guardar</button>
                    </div>
                </div>

                <div id="personnelList" style="max-width: 800px; margin: 20px auto;"></div>

                <div class="form-container" style="max-width: 800px; margin: 20px auto;">
                     <h3><i class="fas fa-file-import"></i> Importar Pessoas em Massa</h3>
                     <div id="personnelCsvUploadArea" class="upload-area">
                         <i class="fas fa-upload"></i>
                         <p>Clique ou arraste o seu ficheiro CSV aqui</p>
                         <input type="file" id="personnelCsvInput" accept=".csv" hidden>
                     </div>
                     <div class="form-actions">
                         <button id="btnDownloadPersonnelCsvTemplate" class="btn-secondary"><i class="fas fa-download"></i> Baixar Modelo CSV</button>
                     </div>
                </div>
            </div>

            <div id="gerenciarUsuarios" class="tab-content" hidden>
                <h2><i class="fas fa-users-cog"></i> Gerir Utilizadores</h2>
                <div class="form-container" style="max-width: 800px; margin: 0 auto 20px auto;">
                    <h3><i class="fas fa-user-plus"></i> Novo Utilizador</h3>
                     <div id="superAdminUserCreation" style="display:none;">
                         <label for="adminTargetCompanyUsers" class="required">Empresa Alvo:</label>
                         <select id="adminTargetCompanyUsers"></select>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="newUserUsername" class="required">E-mail:</label>
                            <input type="email" id="newUserUsername" autocomplete="new-email">
                        </div>
                        <div class="form-col">
                            <label for="newUserPassword" class="required">Senha:</label>
                            <input type="password" id="newUserPassword" autocomplete="new-password">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="newUserRole" class="required">Função (Role):</label>
                            <select id="newUserRole">
                                <option value="user">Utilizador</option>
                                <option value="colaborador">Colaborador</option>
                                <option value="tecnico">Técnico</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="admin">Administrador</option>
                            </select>
                        </div>
                    </div>
                    <div class="permission-grid"></div>
                    <div class="form-actions">
                        <button id="btnCreateUser" class="save"><i class="fas fa-plus"></i> Criar Utilizador</button>
                    </div>
                </div>
                <div id="usersList" style="max-width: 800px; margin: 20px auto;"></div>
            </div>

            <div id="configuracoesEmpresa" class="tab-content" hidden>
                <h2><i class="fas fa-building"></i> Configurações da Empresa</h2>

                <!-- Upload de Logotipo -->
                <div class="form-container">
                    <h3><i class="fas fa-image"></i> Logotipo da Empresa</h3>
                    <div id="logoUploadArea" class="upload-area">
                        <i class="fas fa-upload"></i>
                        <p>Clique ou arraste o logotipo aqui (PNG, JPG - max 1MB)</p>
                        <input type="file" id="logoInput" accept="image/*" hidden>
                    </div>
                    <div class="logo-preview-container">
                        <img id="logoPreview" src="#" alt="Pré-visualização do Logo" style="display: none;">
                        <button id="removeLogoBtn" class="btn-excluir" style="display: none;"><i class="fas fa-trash"></i> Remover Logo</button>
                    </div>
                </div>

                <!-- Metas de Plantio -->
                <div class="form-container">
                    <h3><i class="fas fa-bullseye"></i> Metas de Plantio</h3>
                    <div id="planting-goals-container"></div>
                    <div class="form-actions">
                        <button id="btnSavePlantingGoals" class="save"><i class="fas fa-save"></i> Guardar Metas</button>
                    </div>
                </div>

                <!-- Upload de Relatórios de Colheita -->
                <div class="form-container">
                    <h3><i class="fas fa-file-csv"></i> Importar Progresso da Colheita</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Progresso (Talhões em Andamento)</label>
                             <div id="harvestReportProgressUploadArea" class="upload-area small">
                                <i class="fas fa-upload"></i>
                                <p>Arraste o CSV de progresso</p>
                                <input type="file" id="harvestReportProgressInput" accept=".csv" hidden>
                            </div>
                            <button id="btnDownloadProgressTemplate" class="btn-secondary small-btn"><i class="fas fa-download"></i> Baixar Modelo</button>
                        </div>
                        <div class="form-col">
                             <label>Encerramento (Talhões Finalizados)</label>
                             <div id="harvestReportClosedUploadArea" class="upload-area small">
                                <i class="fas fa-upload"></i>
                                <p>Arraste o CSV de encerrados</p>
                                <input type="file" id="harvestReportClosedInput" accept=".csv" hidden>
                            </div>
                            <button id="btnDownloadClosedTemplate" class="btn-secondary small-btn"><i class="fas fa-download"></i> Baixar Modelo</button>
                        </div>
                    </div>
                </div>

                <!-- Upload de Shapefile -->
                <div class="form-container">
                    <h3><i class="fas fa-map"></i> Contornos do Mapa (Shapefile)</h3>
                    <div id="shapefileUploadArea" class="upload-area">
                        <i class="fas fa-upload"></i>
                        <p>Clique ou arraste o arquivo .zip dos talhões</p>
                        <input type="file" id="shapefileInput" accept=".zip" hidden>
                    </div>
                </div>

                <!-- Upload de Histórico de Colheita para IA -->
                <div class="form-container">
                    <h3><i class="fas fa-brain"></i> Histórico de Colheita para IA (ATR)</h3>
                    <p class="description">Envie um CSV com o histórico de toneladas e ATR por fazenda para treinar a IA a prever o ATR da safra atual.</p>
                     <div id="historicalReportUploadArea" class="upload-area">
                         <i class="fas fa-upload"></i>
                         <p>Clique ou arraste o seu ficheiro CSV aqui</p>
                         <input type="file" id="historicalReportInput" accept=".csv" hidden>
                     </div>
                     <div class="form-actions">
                         <button id="btnDownloadHistoricalTemplate" class="btn-secondary"><i class="fas fa-download"></i> Baixar Modelo CSV</button>
                         <button id="btnDeleteHistoricalData" class="btn-excluir-permanente"><i class="fas fa-skull-crossbones"></i> Apagar Histórico da IA</button>
                     </div>
                </div>

                <!-- Configuração do Método de Cálculo da Cigarrinha -->
                <div class="form-container">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3><i class="fas fa-calculator"></i> Método de Cálculo (Cigarrinha)</h3>
                        <button id="btnViewCalcHistory" class="btn-secondary small-btn"><i class="fas fa-history"></i> Histórico</button>
                    </div>
                     <div class="form-row">
                        <div class="form-col">
                             <label for="cigarrinhaCalcMethod">Divisor para Média (Amostragem):</label>
                            <select id="cigarrinhaCalcMethod">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5" selected>5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-actions">
                        <button id="btnSaveCalcMethod" class="save"><i class="fas fa-save"></i> Guardar Método</button>
                    </div>
                </div>

                <!-- Ações de Limpeza de Dados -->
                <div class="form-container">
                    <h3><i class="fas fa-broom"></i> Limpeza de Dados</h3>
                     <p class="description">Use estas ações com cuidado para corrigir problemas de dados, como registos duplicados.</p>
                     <div class="form-actions">
                        <button id="btnCleanDuplicateTraps" class="btn-excluir"><i class="fas fa-copy"></i> Remover Armadilhas Duplicadas</button>
                    </div>
                </div>

            </div>

            <div id="syncHistory" class="tab-content" hidden>
                <h2><i class="fas fa-history"></i> Histórico de Sincronização</h2>
                <div id="syncHistoryList"></div>
            </div>

            <div id="gerenciarLancamentos" class="tab-content" hidden>
                <h2><i class="fas fa-edit"></i> Gerir Lançamentos</h2>
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="manageDataType">Tipo de Lançamento:</label>
                            <select id="manageDataType">
                                <option value="brocamento">Brocamento</option>
                                <option value="perda">Perda</option>
                                <option value="apontamentoPlantio">Apontamento de Plantio</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="manageStartDate">De:</label>
                            <input type="date" id="manageStartDate">
                        </div>
                        <div class="form-col">
                            <label for="manageEndDate">Até:</label>
                            <input type="date" id="manageEndDate">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button id="btnApplyManageFilters" class="save"><i class="fas fa-filter"></i> Aplicar Filtros</button>
                    </div>
                </div>
                <div id="listaGerenciamento"></div>
            </div>

            <div id="gerenciarEmpresas" class="tab-content" hidden>
                <h2><i class="fas fa-building"></i> Gerir Empresas</h2>
                <div class="form-container" style="max-width: 800px; margin: 0 auto 20px auto;">
                    <h3><i class="fas fa-plus-circle"></i> Nova Empresa</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="newCompanyName" class="required">Nome da Empresa:</label>
                            <input type="text" id="newCompanyName">
                        </div>
                    </div>
                    <fieldset>
                        <legend>Administrador da Empresa</legend>
                        <div class="form-row">
                            <div class="form-col">
                                <label for="newCompanyAdminEmail" class="required">E-mail do Administrador:</label>
                                <input type="email" id="newCompanyAdminEmail" autocomplete="new-email">
                            </div>
                            <div class="form-col">
                                <label for="newCompanyAdminPassword" class="required">Senha Provisória:</label>
                                <input type="password" id="newCompanyAdminPassword" autocomplete="new-password">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset>
                        <legend>Módulos Subscritos</legend>
                        <div id="newCompanyModules" class="report-options-grid"></div>
                    </fieldset>

                    <div class="form-actions">
                        <button id="btnCreateCompany" class="save"><i class="fas fa-plus"></i> Criar Empresa</button>
                    </div>
                </div>

                <div id="companiesList" style="max-width: 800px; margin: 20px auto;"></div>

                <!-- Funcionalidades Globais -->
                <div class="form-container" style="max-width: 800px; margin: 20px auto;">
                    <h3><i class="fas fa-globe"></i> Ativação de Funcionalidades Globais</h3>
                    <p class="description">
                        Ative ou desative funcionalidades para TODAS as empresas. Se uma funcionalidade estiver desativada aqui,
                        nenhuma empresa poderá acedê-la, mesmo que tenha subscrito o módulo.
                    </p>
                    <div id="globalFeaturesGrid" class="permission-grid"></div>
                    <div class="form-actions">
                        <button id="btnSaveGlobalFeatures" class="save"><i class="fas fa-save"></i> Guardar Funcionalidades Globais</button>
                    </div>
                </div>
                <!-- Botão de Migração -->
                <div class="form-container" style="max-width: 800px; margin: 40px auto; border-top: 2px solid var(--color-danger);">
                    <h3><i class="fas fa-database"></i> Ações de Base de Dados</h3>
                    <p class="description">
                        Ação para associar dados antigos (sem ID de empresa) a uma empresa específica. Use com extremo cuidado.
                    </p>
                    <div class="form-actions">
                        <button id="btnMigrateOldData" class="btn-excluir"><i class="fas fa-exchange-alt"></i> Migrar Dados Antigos</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="loginScreen">
        <div id="loginBox">
            <img src="icons/icon-192x192.png" alt="Logo">
            <h2>Bem-vindo ao AgroVetor</h2>

             <form id="loginForm">
                <p>Faça login para continuar</p>
                <div class="input-group">
                    <input type="email" id="loginUser" required placeholder=" ">
                    <label for="loginUser">E-mail</label>
                </div>
                <div class="input-group">
                    <input type="password" id="loginPass" required placeholder=" ">
                    <label for="loginPass">Senha</label>
                </div>
                <button type="button" id="btnLogin">LOGIN</button>
            </form>

             <div id="offlineUserSelection" style="display:none;">
                <p>Sem conexão. Selecione um perfil para login offline.</p>
                 <div class="input-group">
                    <input type="email" id="offlineEmail" required placeholder=" " autocomplete="email">
                    <label for="offlineEmail">Seu E-mail</label>
                </div>
                <div class="input-group">
                    <input type="password" id="offlinePassword" required placeholder=" " autocomplete="current-password">
                    <label for="offlinePassword">Sua Senha</label>
                </div>
                <button type="button" id="btnOfflineLogin">LOGIN OFFLINE</button>
            </div>

            <p id="loginMessage"></p>
        </div>
    </div>

    <div id="alertContainer"></div>

    <div id="notification-container"></div>

    <!-- Modals -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="confirmationModalCloseBtn">&times;</button>
            <h3 id="confirmationModalTitle">Confirmar Ação</h3>
            <p id="confirmationModalMessage"></p>
            <div id="confirmationModalInputContainer" style="display: none;">
                <input type="text" id="confirmationModalInput" placeholder="Digite para confirmar">
            </div>
            <div class="modal-actions">
                <button id="confirmationModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="confirmationModalConfirmBtn" class="save">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="changePasswordModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="changePasswordModalCloseBtn">&times;</button>
            <h3>Alterar Senha</h3>
            <div class="input-group">
                <input type="password" id="currentPassword" required placeholder=" " autocomplete="current-password">
                <label for="currentPassword">Senha Atual</label>
            </div>
            <div class="input-group">
                <input type="password" id="newPassword" required placeholder=" " autocomplete="new-password">
                <label for="newPassword">Nova Senha</label>
            </div>
            <div class="input-group">
                <input type="password" id="confirmNewPassword" required placeholder=" " autocomplete="new-password">
                <label for="confirmNewPassword">Confirme a Nova Senha</label>
            </div>
            <div class="modal-actions">
                <button id="changePasswordModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="changePasswordModalSaveBtn" class="save">Guardar</button>
            </div>
        </div>
    </div>

     <div class="modal-overlay" id="adminPasswordConfirmModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="adminPasswordConfirmModalCloseBtn">&times;</button>
            <h3><i class="fas fa-user-shield"></i> Confirmação de Administrador</h3>
            <p>Por favor, insira a sua senha de administrador para executar esta ação.</p>
            <div class="input-group">
                <input type="password" id="adminConfirmPassword" required placeholder=" " autocomplete="current-password">
                <label for="adminConfirmPassword">Sua Senha</label>
            </div>
            <div class="modal-actions">
                <button id="adminPasswordConfirmModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="adminPasswordConfirmModalConfirmBtn" class="save">Confirmar e Executar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="enableOfflineLoginModal">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h3><i class="fas fa-user-lock"></i> Habilitar Login Offline</h3>
            <p>Para sua segurança, insira a sua senha atual para habilitar ou atualizar o acesso offline neste aparelho.</p>
            <div class="input-group">
                <input type="password" id="enableOfflinePassword" required placeholder=" " autocomplete="current-password">
                <label for="enableOfflinePassword">Sua Senha Atual</label>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary btn-cancel">Cancelar</button>
                <button id="btnConfirmEnableOffline" class="save">Habilitar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="chartModal">
        <div class="modal-content large">
            <button class="modal-close-btn" id="chartModalCloseBtn">&times;</button>
            <h3 id="chartModalTitle"></h3>
            <div class="chart-container-expanded">
                <canvas id="expandedChartCanvas"></canvas>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="userEditModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="userEditModalCloseBtn">&times;</button>
            <h3 id="userEditModalTitle">Editar Utilizador</h3>
            <input type="hidden" id="editingUserId">
            <div class="form-row">
                <div class="form-col">
                    <label for="editUserUsername">E-mail (não pode ser alterado):</label>
                    <input type="email" id="editUserUsername" readonly>
                </div>
                 <div class="form-col">
                    <label for="editUserRole">Função (Role):</label>
                    <select id="editUserRole">
                        <option value="user">Utilizador</option>
                        <option value="colaborador">Colaborador</option>
                        <option value="tecnico">Técnico</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>
            </div>
            <div id="editUserPermissionGrid" class="permission-grid"></div>
            <div class="modal-actions" style="justify-content: space-between; margin-top: 20px;">
                 <div>
                    <button id="btnResetPassword" class="btn-secondary"><i class="fas fa-envelope"></i> Redefinir Senha</button>
                    <button id="btnDeleteUser" class="btn-excluir"><i class="fas fa-trash"></i> Desativar Utilizador</button>
                </div>
                <button id="btnSaveUserChanges" class="save"><i class="fas fa-save"></i> Guardar Alterações</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editCompanyModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="editCompanyModalCloseBtn">&times;</button>
            <h3>Editar Módulos da Empresa: <span id="editCompanyNameDisplay" style="color: var(--color-primary);"></span></h3>
            <input type="hidden" id="editingCompanyId">
            <p class="description">Selecione os módulos que esta empresa terá acesso.</p>
            <div id="editCompanyModulesGrid" class="report-options-grid"></div>
            <div class="modal-actions">
                <button id="editCompanyModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="editCompanyModalSaveBtn" class="save">Guardar Alterações</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editFarmModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="editFarmModalCloseBtn">&times;</button>
            <h3>Editar Fazenda</h3>
            <input type="hidden" id="editingFarmId">
            <div class="form-col">
                <label for="editFarmNameInput">Nome da Fazenda:</label>
                <input type="text" id="editFarmNameInput" style="text-transform:uppercase" oninput="this.value = this.value.toUpperCase()">
            </div>
             <div class="form-col" style="margin-top:15px;">
                <label>Tipo:</label>
                <div class="checkbox-group" id="editFarmTypeCheckboxes">
                    <label class="checkbox-container">Própria <input type="checkbox" value="Própria"><span class="checkmark"></span></label>
                    <label class="checkbox-container">Parceira <input type="checkbox" value="Parceira"><span class="checkmark"></span></label>
                    <label class="checkbox-container">Arrendada <input type="checkbox" value="Arrendada"><span class="checkmark"></span></label>
                </div>
            </div>
            <div class="modal-actions">
                <button id="editFarmModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="editFarmModalSaveBtn" class="save">Guardar Alterações</button>
            </div>
        </div>
    </div>

     <div class="modal-overlay" id="trapPlacementModal">
        <div class="modal-content" style="max-width: 450px;">
            <button class="modal-close-btn" id="trapPlacementModalCloseBtn">&times;</button>
            <h3>Instalar Armadilha</h3>
            <div id="trapPlacementModalBody"></div>
            <div class="modal-actions">
                <button id="trapPlacementModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="trapPlacementModalManualBtn" class="btn-secondary"><i class="fas fa-mouse-pointer"></i> Seleção Manual</button>
                <button id="trapPlacementModalConfirmBtn" class="save" style="display: none;">Confirmar Instalação</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyFilterModal">
        <div class="modal-content" style="max-width: 500px;">
             <button class="modal-close-btn" id="historyFilterModalCloseBtn">&times;</button>
            <h3>Visualizar Histórico de Rota</h3>
            <div class="form-col">
                <label for="historyUserSelectModal">Utilizador:</label>
                <select id="historyUserSelectModal"></select>
            </div>
             <div class="form-row">
                <div class="form-col">
                    <label for="historyStartDateModal">Data Início:</label>
                    <input type="date" id="historyStartDateModal">
                </div>
                 <div class="form-col">
                    <label for="historyEndDateModal">Data Fim:</label>
                    <input type="date" id="historyEndDateModal">
                </div>
            </div>
             <div class="modal-actions">
                <button id="historyFilterModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="btnClearHistoryModal" class="btn-excluir">Limpar Rota</button>
                <button id="btnViewHistoryModal" class="save"><i class="fas fa-route"></i> Ver Rota</button>
            </div>
        </div>
    </div>

     <div class="modal-overlay" id="syncHistoryDetailModal">
        <div class="modal-content large">
            <button class="modal-close-btn" id="syncHistoryDetailModalCloseBtn">&times;</button>
            <h3 id="syncHistoryDetailModalTitle">Detalhes da Sincronização</h3>
            <div id="syncHistoryDetailModalBody"></div>
            <div class="modal-actions">
                <button id="syncHistoryDetailModalCancelBtn" class="btn-secondary">Fechar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="configHistoryModal">
        <div class="modal-content large">
            <button class="modal-close-btn" id="configHistoryModalCloseBtn">&times;</button>
            <h3 id="configHistoryModalTitle">Histórico de Alterações de Configuração</h3>
            <div id="configHistoryModalBody"></div>
            <div class="modal-actions">
                <button id="configHistoryModalCancelBtn" class="btn-secondary">Fechar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA CRIAÇÃO DE PONTO DE PLANEAMENTO -->
    <div class="modal-overlay" id="planningPointModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="planningPointModalCloseBtn">&times;</button>
            <h3>Ponto de Planeamento</h3>
            <form id="planningPointForm">
                <input type="hidden" id="planningPointId">
                <div class="form-col">
                    <strong>Fazenda:</strong> <span id="planningPointFazenda"></span>
                </div>
                <div class="form-col">
                    <strong>Talhão:</strong> <span id="planningPointTalhao"></span>
                </div>
                 <div class="form-row">
                    <div class="form-col">
                        <label for="planningPointDataPrevista" class="required">Data Prevista:</label>
                        <input type="date" id="planningPointDataPrevista" required>
                    </div>
                    <div class="form-col">
                        <label for="planningPointResponsavel" class="required">Responsável:</label>
                        <select id="planningPointResponsavel" required></select>
                    </div>
                </div>
                 <div class="form-col">
                    <label for="planningPointObservacoes">Observações:</label>
                    <textarea id="planningPointObservacoes" rows="3"></textarea>
                </div>
            </form>
            <div class="modal-actions">
                <button id="planningPointModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="planningPointModalDeleteBtn" class="btn-excluir" style="display: none;">Excluir</button>
                <button id="planningPointModalSaveBtn" class="save">Salvar Ponto</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL PARA GERAR ORDEM DE SERVIÇO -->
    <div class="modal-overlay" id="generateOSModal">
        <div class="modal-content">
            <button class="modal-close-btn" id="generateOSModalCloseBtn">&times;</button>
            <h3>Gerar Ordem de Serviço</h3>
            <p>A gerar OS para <strong id="selectedPointsCount">0</strong> ponto(s) selecionado(s).</p>
            <div class="form-col">
                <label for="osResponsavel" class="required">Responsável pela OS:</label>
                <select id="osResponsavel" required></select>
            </div>
            <div class="form-col">
                <label for="osPrazoExecucao" class="required">Prazo de Execução:</label>
                <input type="date" id="osPrazoExecucao" required>
            </div>
            <div class="form-col">
                <label for="osObservacoes">Observações:</label>
                <textarea id="osObservacoes" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button id="generateOSModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="generateOSModalSaveBtn" class="save">Gerar OS</button>
            </div>
        </div>
    </div>


    <script type="module" src="app.js"></script>
    <script nomodule src="app.js"></script>

</body>

</html>
