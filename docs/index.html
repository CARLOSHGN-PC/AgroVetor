<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>AgroVetor - Inspeção e Planejamento</title>

    <!-- PWA (Progressive Web App) Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#2e7d32">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="splash-screen">
        <img src="icons/icon-512x512.png" alt="AgroVetor Logo" class="splash-logo">
        <p class="splash-message">Bem-vindo ao futuro do agronegócio.</p>
    </div>

    <div id="alertContainer"></div>
    <div id="notification-container"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-progress-text" style="color: var(--color-ai); font-weight: 500;">A processar...</p>
    </div>

    <div id="loginScreen" style="display: none;">
        <div id="loginBox" role="main" aria-label="Tela de login">
            <div id="loginForm">
                <h2><i class="fas fa-leaf"></i> AGROVETOR</h2>
                <div class="input-field">
                    <input id="loginUser" type="email" placeholder=" " required />
                    <label for="loginUser">Email</label>
                </div>
                <div class="input-field">
                    <input id="loginPass" type="password" placeholder=" " required autocomplete="new-password" />
                    <label for="loginPass">Senha</label>
                </div>
                <button id="btnLogin" aria-label="Botão de login"><i class="fas fa-sign-in-alt"></i> LOGIN</button>
                <div id="loginMessage" role="alert" aria-live="assertive"></div>
            </div>
            
            <div id="offlineUserSelection" style="display: none;">
                <h2><i class="fas fa-wifi-slash"></i> Acesso Offline</h2>
                <p style="color: var(--color-text-light); margin-bottom: 20px;">Selecione seu perfil para continuar.</p>
                <div id="offlineUserList"></div>
            </div>
        </div>
    </div>

    <div id="appScreen" style="display:none; flex:1; flex-direction: column;">
        <header>
            <button class="menu-toggle" id="btnToggleMenu" aria-label="Abrir menu" aria-expanded="false" aria-controls="menu">
                <div></div><div></div><div></div>
            </button>
            <div class="header-title-container">
                <!-- ALTERAÇÃO PONTO 3: Texto do título removido -->
                <h1 id="headerLogo" style="cursor: pointer;"><i class="fas fa-leaf"></i></h1>
            </div>
            
            <div class="header-actions-container">
                <div id="notification-bell-container" class="notification-bell" style="display: none;">
                    <button id="notification-bell-toggle" aria-label="Notificações">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count">0</span>
                    </button>
                    <div id="notification-dropdown">
                        <div class="notification-header">
                            <span>Notificações</span>
                            <button id="clear-notifications-btn">Limpar</button>
                        </div>
                        <div id="notification-list">
                            <!-- Itens de notificação aqui -->
                        </div>
                        <div id="no-notifications" style="display: none;">
                            <p>Nenhuma notificação nova.</p>
                        </div>
                    </div>
                </div>

                <div id="user-menu-container" style="display:none;">
                    <button id="user-menu-toggle" aria-label="Menu do Utilizador" aria-haspopup="true" aria-expanded="false">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <div id="user-menu-dropdown" role="menu">
                        <div class="user-menu-header">
                            <p><strong>Conectado como:</strong></p>
                            <p id="userMenuUsername"></p>
                        </div>
                        <div id="currentDateTime" class="user-menu-item"></div>
                        <hr>
                        <div class="theme-selector-container">
                            <p>Tema</p>
                            <div class="theme-buttons">
                                <button id="theme-green" class="theme-button" title="Verde (Padrão)"></button>
                                <button id="theme-blue" class="theme-button" title="Azul"></button>
                                <button id="theme-dark" class="theme-button" title="Escuro"></button>
                            </div>
                        </div>
                        <hr>
                        <button id="installAppBtn" role="menuitem" class="user-menu-item is-action" style="display: none;">
                            <i class="fas fa-download"></i> Instalar App
                        </button>
                        <button id="manualSyncBtn" role="menuitem" class="user-menu-item is-action">
                            <i class="fas fa-sync"></i> Sincronizar Manualmente
                        </button>
                        <button id="changePasswordBtn" role="menuitem" class="user-menu-item is-action">
                            <i class="fas fa-key"></i> Alterar Senha
                        </button>
                        <button id="logoutBtn" role="menuitem" class="user-menu-item is-action">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <nav class="menu" id="menu" aria-label="Menu Principal" tabindex="-1"></nav>
        
        <main class="content" id="content">
            <section id="dashboard" class="tab-content" aria-label="Dashboard" tabindex="0" hidden>
                
                <div id="dashboard-selector" class="dashboard-selector-grid">
                    <div id="card-broca" class="dashboard-card">
                        <i class="icon fas fa-bug"></i>
                        <h3>Broca</h3>
                        <p>Analisar índices de infestação, locais mais afetados e evolução mensal.</p>
                    </div>
                    <div id="card-perda" class="dashboard-card">
                        <i class="icon fas fa-chart-line"></i>
                        <h3>Perdas</h3>
                        <p>Visualizar perdas por fazenda, tipo de perda e evolução mensal.</p>
                    </div>
                    <div id="card-plantio" class="dashboard-card">
                        <i class="icon fas fa-seedling"></i>
                        <h3>Plantio</h3>
                        <p>Acompanhar desempenho diário e evolução da frente de plantio.</p>
                    </div>
                    <div id="card-aerea" class="dashboard-card">
                        <i class="icon fas fa-satellite-dish"></i>
                        <h3>Monitoramento Aéreo</h3>
                        <p>Monitorar nível de infestação, risco e custos de controle.</p>
                    </div>
                    <div id="card-cigarrinha" class="dashboard-card">
                        <i class="icon fas fa-bug-slash"></i>
                        <h3>Cigarrinha</h3>
                        <p>Acompanhar intensidade da praga e eficiência de controle.</p>
                    </div>
                     <div id="card-clima" class="dashboard-card" style="border-color: #29b6f6;">
                        <i class="icon fas fa-cloud-sun-rain" style="color: #29b6f6;"></i>
                        <h3>Clima</h3>
                        <p>Analisar dados climatológicos como temperatura, chuva e vento.</p>
                    </div>
                </div>

                <div id="dashboard-clima" class="dashboard-view" style="display: none;">
                    <div class="dashboard-header">
                        <div class="dashboard-header-main">
                            <h2 style="color: #29b6f6;"><i class="fas fa-cloud-sun-rain"></i> Dashboard Climatológico</h2>
                            <div class="dashboard-filters">
                                <label for="climaDashboardInicio">De:</label>
                                <input type="date" id="climaDashboardInicio">
                                <label for="climaDashboardFim">Até:</label>
                                <input type="date" id="climaDashboardFim">
                                <label for="climaDashboardFazenda" style="margin-left: 10px;">Fazenda:</label>
                                <select id="climaDashboardFazenda" style="padding: 6px 10px; font-size: 13px; max-width: 150px; margin-top:0;">
                                    <option value="">Todas</option>
                                </select>
                                <button id="btnFiltrarClimaDashboard" class="save"><i class="fas fa-filter"></i> Filtrar</button>
                            </div>
                        </div>
                        <button id="btn-back-to-selector-clima" class="btn-back-dashboard"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="kpi-grid" id="clima-kpi-grid">
                        <div class="kpi-card" style="border-left-color: var(--color-danger);">
                            <div class="icon" style="background-color: var(--color-danger);"><i class="fas fa-thermometer-three-quarters"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-clima-temp-max">0°C</p>
                                <p class="label">Temp. Máxima Média</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-info);">
                            <div class="icon" style="background-color: var(--color-info);"><i class="fas fa-thermometer-quarter"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-clima-temp-min">0°C</p>
                                <p class="label">Temp. Mínima Média</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: #29b6f6;">
                            <div class="icon" style="background-color: #29b6f6;"><i class="fas fa-cloud-showers-heavy"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-clima-pluviosidade">0 mm</p>
                                <p class="label">Pluviosidade Acumulada</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: #66bb6a;">
                            <div class="icon" style="background-color: #66bb6a;"><i class="fas fa-tint"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-clima-umidade">0%</p>
                                <p class="label">Umidade Média</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-warning);">
                            <div class="icon" style="background-color: var(--color-warning);"><i class="fas fa-wind"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-clima-vento">0 km/h</p>
                                <p class="label">Vento Médio</p>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">Variação de Temperatura (°C)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoVariacaoTemperatura"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoVariacaoTemperatura"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Acúmulo de Pluviosidade (mm)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoAcumuloPluviosidade"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoAcumuloPluviosidade"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Média da Velocidade do Vento (km/h) por Fazenda</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoMediaVentoFazenda"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoMediaVentoFazenda"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Índice Climatológico Comparativo</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoIndiceClimatologico"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoIndiceClimatologico"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="dashboard-broca" style="display: none;">
                    <div class="dashboard-header">
                        <div class="dashboard-header-main">
                            <h2 style="color: var(--color-danger);"><i class="fas fa-bug"></i> Dashboard de Broca</h2>
                            <div class="dashboard-filters" id="brocaDashboardDateFilter">
                                <label for="brocaDashboardInicio">De:</label>
                                <input type="date" id="brocaDashboardInicio">
                                <label for="brocaDashboardFim">Até:</label>
                                <input type="date" id="brocaDashboardFim">
                                <button id="btnFiltrarBrocaDashboard" class="save"><i class="fas fa-filter"></i> Filtrar</button>
                            </div>
                        </div>
                        <button id="btn-back-to-selector-broca" class="btn-back-dashboard"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">Top 10 Fazendas com Maior Índice de Broca (Ponderado)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoTop10FazendasBroca" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoTop10FazendasBroca"></canvas></div>
                        </div>
                         <div class="chart-card">
                            <h3 class="chart-title">Evolução Mensal do Índice de Broca (%)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoBrocaMensal" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoBrocaMensal"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Posição de Maior Incidência da Broca (%)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoBrocaPosicao" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoBrocaPosicao"></canvas></div>
                        </div>
                         <div class="chart-card">
                            <h3 class="chart-title">Top 10 Variedades com Maior Índice de Broca (%)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoBrocaPorVariedade" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoBrocaPorVariedade"></canvas></div>
                        </div>
                    </div>
                </div>

                 <div id="dashboard-perda" style="display: none;">
                    <div class="dashboard-header">
                        <div class="dashboard-header-main">
                            <h2 style="color: var(--color-warning);"><i class="fas fa-chart-line"></i> Dashboard de Perdas</h2>
                            <div class="dashboard-filters" id="perdaDashboardDateFilter">
                                <label for="perdaDashboardInicio">De:</label>
                                <input type="date" id="perdaDashboardInicio">
                                <label for="perdaDashboardFim">Até:</label>
                                <input type="date" id="perdaDashboardFim">
                                <button id="btnFiltrarPerdaDashboard" class="save"><i class="fas fa-filter"></i> Filtrar</button>
                            </div>
                        </div>
                        <button id="btn-back-to-selector-perda" class="btn-back-dashboard"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">Perda Média por Frente / Turno (kg)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoPerdaPorFrenteTurno" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoPerdaPorFrenteTurno"></canvas></div>
                        </div>
                         <div class="chart-card">
                            <h3 class="chart-title">Composição da Perda por Frente (kg)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoComposicaoPerda" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoComposicaoPerda"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Top 10 Fazendas com Maior Perda Média (kg)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoTop10FazendasPerda" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoTop10FazendasPerda"></canvas></div>
                        </div>
                         <div class="chart-card">
                            <h3 class="chart-title">Perda Média por Frente de Serviço (kg)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoPerdaPorFrente" title="Expandir Gráfico"><i class="fas fa-expand"></i></button>
                            <div class="chart-container"><canvas id="graficoPerdaPorFrente"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="dashboard-aerea" class="dashboard-view" style="display: none;">
                    <div class="dashboard-header">
                         <div class="dashboard-header-main">
                            <h2 style="color: var(--color-info);"><i class="fas fa-satellite-dish"></i> Dashboard de Monitoramento Aéreo</h2>
                            <div class="dashboard-filters">
                                <label for="aereoDashboardInicio">De:</label>
                                <input type="date" id="aereoDashboardInicio">
                                <label for="aereoDashboardFim">Até:</label>
                                <input type="date" id="aereoDashboardFim">
                                <button id="btnFiltrarAereoDashboard" class="save"><i class="fas fa-filter"></i> Filtrar</button>
                            </div>
                        </div>
                        <button id="btn-back-to-selector-aerea" class="btn-back-dashboard"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card" style="border-left-color: var(--color-info);">
                            <div class="icon" style="background-color: var(--color-info);"><i class="fas fa-tractor"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-aereo-fazendas-monitoradas">0</p>
                                <p class="label">Fazendas Monitoradas</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-danger);">
                            <div class="icon" style="background-color: var(--color-danger);"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-aereo-fazendas-risco">0%</p>
                                <p class="label">% de Fazendas em Risco (>30%)</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-warning);">
                             <div class="icon" style="background-color: var(--color-warning);"><i class="fas fa-bug"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-aereo-infestacao-media">0</p>
                                <p class="label">Média de Mariposas / Armadilha</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-success);">
                           <div class="icon" style="background-color: var(--color-success);"><i class="fas fa-dollar-sign"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-aereo-custo-total">R$ 0,00</p>
                                <p class="label">Custo Total (Placeholder)</p>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">Proporção de Fazendas em Risco</h3>
                             <button class="btn-expand-chart" data-chart-id="graficoFazendasRisco"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoFazendasRisco"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Nível de Risco por Fazenda (%)</h3>
                             <button class="btn-expand-chart" data-chart-id="graficoRiscoPorFazenda"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoRiscoPorFazenda"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Tendência da Infestação (Média de Mariposas/Dia)</h3>
                             <button class="btn-expand-chart" data-chart-id="graficoTendenciaAerea"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoTendenciaAerea"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Custo por Fazenda (Placeholder)</h3>
                             <button class="btn-expand-chart" data-chart-id="graficoCustoAereo"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoCustoAereo"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="dashboard-plantio" class="dashboard-view" style="display: none;">
                    <div class="dashboard-header">
                        <div class="dashboard-header-main">
                            <h2 style="color: var(--color-success);"><i class="fas fa-seedling"></i> Dashboard de Plantio</h2>
                            <div class="dashboard-filters">
                                <label for="plantioDashboardInicio">De:</label>
                                <input type="date" id="plantioDashboardInicio">
                                <label for="plantioDashboardFim">Até:</label>
                                <input type="date" id="plantioDashboardFim">
                                <label for="plantioDashboardCultura" style="margin-left: 10px;">Cultura:</label>
                                <select id="plantioDashboardCultura" style="padding: 6px 10px; font-size: 13px; max-width: 150px; margin-top:0;">
                                    <option value="">Todas</option>
                                    <option value="Cana-de-açúcar">Cana-de-açúcar</option>
                                    <option value="Soja">Soja</option>
                                    <option value="Milho">Milho</option>
                                </select>
                                <button id="btnFiltrarPlantioDashboard" class="save"><i class="fas fa-filter"></i> Filtrar</button>
                            </div>
                        </div>
                        <button id="btn-back-to-selector-plantio" class="btn-back-dashboard"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card" style="border-left-color: var(--color-success);">
                            <div class="icon" style="background-color: var(--color-success);"><i class="fas fa-ruler-combined"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-plantio-area-total">0 ha</p>
                                <p class="label">Área Total Plantada</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-info);">
                            <div class="icon" style="background-color: var(--color-info);"><i class="fas fa-bullseye"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-plantio-meta">1.000 ha</p>
                                <p class="label">Meta de Plantio</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-accent);">
                            <div class="icon" style="background-color: var(--color-accent);"><i class="fas fa-tasks"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-plantio-percentual">0%</p>
                                <p class="label">Percentual Concluído</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-purple);">
                            <div class="icon" style="background-color: var(--color-purple);"><i class="fas fa-chart-line"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-plantio-media-diaria">0 ha/dia</p>
                                <p class="label">Média Diária por Cultura</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-warning);">
                            <div class="icon" style="background-color: var(--color-warning);"><i class="fas fa-hourglass-half"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-plantio-area-restante">0 ha</p>
                                <p class="label">Área Restante</p>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">Área Plantada por Mês</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoAreaPlantadaPorDia"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoAreaPlantadaPorDia"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Produtividade por Frente de Plantio</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoProdutividadePorFrente"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoProdutividadePorFrente"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Evolução Acumulada da Área Plantada</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoEvolucaoAreaPlantada"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoEvolucaoAreaPlantada"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Percentual Total de Conclusão</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoConclusaoPlantio"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoConclusaoPlantio"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Chuva por Fazenda (Média)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoChuvaPorFazenda"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoChuvaPorFazenda"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="dashboard-cigarrinha" class="dashboard-view" style="display: none;">
                    <div class="dashboard-header">
                        <div class="dashboard-header-main">
                            <h2 style="color: var(--color-purple);"><i class="fas fa-bug-slash"></i> Dashboard de Cigarrinha</h2>
                            <div class="dashboard-filters">
                                <label for="cigarrinhaDashboardInicio">De:</label>
                                <input type="date" id="cigarrinhaDashboardInicio">
                                <label for="cigarrinhaDashboardFim">Até:</label>
                                <input type="date" id="cigarrinhaDashboardFim">
                                <button id="btnFiltrarCigarrinhaDashboard" class="save"><i class="fas fa-filter"></i> Filtrar</button>
                            </div>
                        </div>
                        <button id="btn-back-to-selector-cigarrinha" class="btn-back-dashboard"><i class="fas fa-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="kpi-grid">
                        <div class="kpi-card" style="border-left-color: var(--color-purple);">
                            <div class="icon" style="background-color: var(--color-purple);"><i class="fas fa-leaf"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-cigarrinha-infestacao-media">0.0</p>
                                <p class="label">Infestação Média</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-info);">
                            <div class="icon" style="background-color: var(--color-info);"><i class="fas fa-th-large"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-cigarrinha-talhoes-avaliados">0</p>
                                <p class="label">Talhões Avaliados</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-success);">
                            <div class="icon" style="background-color: var(--color-success);"><i class="fas fa-shield-alt"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-cigarrinha-eficiencia-controle">N/A</p>
                                <p class="label">Eficiência de Controle</p>
                            </div>
                        </div>
                        <div class="kpi-card" style="border-left-color: var(--color-danger);">
                            <div class="icon" style="background-color: var(--color-danger);"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="text">
                                <p class="value" id="kpi-cigarrinha-talhoes-alerta">0</p>
                                <p class="label">Talhões em Alerta</p>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-grid">
                        <div class="chart-card">
                            <h3 class="chart-title">Infestação Média por Talhão</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoInfestacaoMediaTalhao"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoInfestacaoMediaTalhao"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Tendência da Infestação</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoTendenciaCigarrinha"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoTendenciaCigarrinha"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Eficiência de Controle (Antes vs. Depois)</h3>
                            <button class="btn-expand-chart" data-chart-id="graficoEficienciaControle"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoEficienciaControle"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <h3 class="chart-title">Distribuição por Nível de Infestação</h3>
                             <button class="btn-expand-chart" data-chart-id="graficoNivelInfestacao"><i class="fas fa-expand-alt"></i></button>
                            <div class="chart-container"><canvas id="graficoNivelInfestacao"></canvas></div>
                        </div>
                    </div>
                </div>

            </section>
            
            <section id="planejamentoColheita" class="tab-content card" aria-label="Planejamento de Colheita" tabindex="0" hidden>
                <div class="card-header-actions">
                    <h2 style="color: var(--color-success); margin: 0;"><i class="fas fa-stream"></i> Planejamento de Colheita</h2>
                    <div class="button-group">
                        <button id="btnAddNewHarvestPlan" class="save"><i class="fas fa-plus"></i> Novo Plano</button>
                    </div>
                </div>
                <div id="superAdminHarvestCreation" class="card" style="display: none; border-left-color: var(--color-purple); margin-top: 20px; margin-bottom: 0;">
                    <h4><i class="fas fa-user-shield"></i> Ação como Super Admin</h4>
                    <p>Para criar um novo plano de colheita, por favor, selecione a empresa à qual ele pertencerá.</p>
                    <label for="adminTargetCompanyHarvest" class="required">Empresa Alvo:</label>
                    <select id="adminTargetCompanyHarvest" required></select>
                </div>

                <div id="harvest-plans-list-container">
                    <h3 style="margin-top: 30px;"><i class="fas fa-tasks"></i> Planos Guardados</h3>
                    <div id="harvest-plans-list"></div>
                </div>
                
                <div id="harvest-plan-editor" style="display: none;">
                    <div class="card" style="border-left-color: var(--color-success); margin-top:20px;">
                        <h3><i class="fas fa-cogs"></i> Configurações da Frente de Colheita</h3>
                        <div class="form-row">
                            <div class="form-col"><label for="harvestFrontName" class="required">Nome da Frente:</label><input type="text" id="harvestFrontName" placeholder="Ex: Frente 01" required></div>
                            <div class="form-col"><label for="harvestStartDate" class="required">Data de Início:</label><input type="date" id="harvestStartDate" required></div>
                            <div class="form-col"><label for="harvestDailyRate" class="required">Média Toneladas/Dia:</label><input type="number" id="harvestDailyRate" value="750" required></div>
                        </div>
                    </div>

                    <div class="card" style="border-left-color: var(--color-success);">
                        <h3 id="addOrEditSequenceTitle"><i class="fas fa-plus-circle"></i> Adicionar Fazenda à Sequência</h3>
                        <input type="hidden" id="editingGroupId">
                        <div class="form-row">
                            <div class="form-col" style="flex-grow: 2;"><label for="harvestFazenda" class="required">Fazenda:</label><select id="harvestFazenda" required></select></div>
                            <div class="form-col">
                                <label for="harvestAtr" class="required">ATR Previsto:</label>
                                <div style="display: flex; align-items: center;">
                                    <input type="number" id="harvestAtr" placeholder="ATR Previsto">
                                    <i id="atr-spinner" class="fas fa-spinner fa-spin" style="display: none; margin-left: 10px; color: var(--color-primary);"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col">
                                <label for="harvestMaturador">Maturador Aplicado:</label>
                                <input type="text" id="harvestMaturador" placeholder="Nome do produto">
                            </div>
                            <div class="form-col">
                                <label for="harvestMaturadorDate">Data de Aplicação:</label>
                                <input type="date" id="harvestMaturadorDate">
                            </div>
                        </div>
                        
                        <div id="harvestTalhaoSelectionContainer">
                            <label>Talhões Disponíveis: <input type="checkbox" id="selectAllTalhoes" style="width: auto; margin-left: 10px;"> <span style="font-size: 14px; color: var(--color-text-light);">Selecionar Todos</span></label>
                            <div id="harvestTalhaoSelectionList" class="talhao-selection-list"></div>
                        </div>
                        <div class="form-row" style="align-items: flex-end;">
                            <div class="form-col"><button class="save" id="btnAddOrUpdateHarvestSequence"><i class="fas fa-plus"></i> Adicionar à Sequência</button></div>
                            <div class="form-col"><button id="btnOptimizeHarvest" class="btn-ai"><i class="fas fa-magic"></i> Otimizar Sequência</button></div>
                            <div class="form-col"><button id="btnCancelEditSequence" class="btn-secondary" style="display: none;"><i class="fas fa-times"></i> Cancelar Edição</button></div>
                        </div>
                    </div>

                    <h3><i class="fas fa-list-ol"></i> Sequência de Colheita</h3>
                    <div class="table-responsive">
                        <table id="harvestPlanTable">
                            <thead>
                                <tr>
                                    <th>Seq.</th>
                                    <th>Fazenda</th>
                                    <th>Talhões</th>
                                    <th>Área (ha)</th>
                                    <th>Prod. (ton)</th>
                                    <th>ATR</th>
                                    <th>Idade (m)</th>
                                    <th>Maturador</th>
                                    <th>Dias Aplic.</th>
                                    <th>Ação</th>
                                    <th>Entrada</th>
                                    <th>Saída</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="harvestSummary" class="harvest-summary"></div>
                    <div style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                        <button id="btnSaveHarvestPlan" class="save"><i class="fas fa-save"></i> Guardar Plano</button>
                        <button id="btnCancelHarvestPlan" class="btn-secondary"><i class="fas fa-times"></i> Voltar para a Lista</button>
                    </div>
                </div>
            </section>

            <section id="planejamento" class="tab-content card" aria-label="Planejamento de Inspeções" tabindex="0" hidden>
                <h2><i class="fas fa-calendar-alt"></i> Planejamento de Inspeções</h2>
                <div class="card" style="border-left-color: var(--color-info);">
                    <h3><i class="fas fa-plus-circle"></i> Agendar Nova Inspeção</h3>
                    <div class="form-row">
                        <div class="form-col"><label for="planoTipo" class="required">Tipo de Inspeção:</label><select id="planoTipo" required><option value="broca">Brocamento</option><option value="perda">Perda na Colheita</option></select></div>
                        <div class="form-col"><label for="planoFazenda" class="required">Fazenda:</label><select id="planoFazenda" required></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><label for="planoTalhao" class="required">Talhão:</label><input type="text" id="planoTalhao" placeholder="Ex: T-23A" required></div>
                        <div class="form-col"><label for="planoData" class="required">Data Prevista:</label><input type="date" id="planoData" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><label for="planoResponsavel" class="required">Responsável:</label><select id="planoResponsavel" required></select></div>
                        <div class="form-col"><label for="planoMeta">Meta (Opcional):</label><input type="number" id="planoMeta" placeholder="Ex: 2 (% broca) ou 500 (kg perda)"></div>
                    </div>
                    <label for="planoObs">Observações:</label>
                    <textarea id="planoObs" placeholder="Detalhes adicionais sobre o planejamento..."></textarea>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <button class="save" id="btnAgendarInspecao" style="max-width: 300px; background: linear-gradient(to right, var(--color-info), #42a5f5);"><i class="fas fa-calendar-check"></i> Agendar Inspeção</button>
                        <button id="btnSugerirPlano" class="btn-ai" style="max-width: 300px; margin-top: 24px;">✨ Obter Sugestões da IA</button>
                    </div>
                </div>
                <h3><i class="fas fa-tasks"></i> Inspeções Agendadas</h3>
                <div id="listaPlanejamento"></div>
            </section>

            <section id="lancamentoBroca" class="tab-content card" aria-label="Lançamento Broca" tabindex="0" hidden>
                <h2><i class="fas fa-bug"></i> Lançamento Broca</h2>
                <div class="form-row">
                    <div class="form-col">
                        <label for="codigo" class="required">Fazenda:</label>
                        <select id="codigo" class="required"></select>
                    </div>
                    <div class="form-col">
                        <label for="data" class="required">Data da Inspeção:</label>
                        <input type="date" id="data" required />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                            <label for="talhao" class="required">Talhão:</label>
                            <input type="text" id="talhao" placeholder="Ex: T12, T15-A" required />
                            <div id="varietyDisplay" class="info-display"></div>
                    </div>
                        <div class="form-col">
                        <label for="entrenos" class="required">Entrenós Contados:</label>
                        <input type="number" id="entrenos" min="1" placeholder="0" required />
                    </div>
                </div>
                    <div class="form-row">
                    <div class="form-col"><label for="brocaBase" class="required">Brocado Base:</label><input type="number" id="brocaBase" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="brocaMeio" class="required">Brocado Meio:</label><input type="number" id="brocaMeio" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="brocaTopo" class="required">Brocado Topo:</label><input type="number" id="brocaTopo" min="0" placeholder="0" /></div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="brocado">Total de Brocado (Automático):</label>
                        <input type="number" id="brocado" min="0" placeholder="0" readonly style="background-color: #eee;" />
                    </div>
                </div>
                <div class="resultado" id="resultado"></div>
                <button class="save" type="button" id="btnSalvarBrocamento"><i class="fas fa-save"></i> Guardar Inspeção</button>
            </section>
            
            <section id="relatorioBroca" class="tab-content card" aria-label="Relatório Broca" tabindex="0" hidden>
                <h2><i class="fas fa-chart-bar"></i> Relatório de Inspeção de Cana (Brocamento)</h2>
                <div class="form-row">
                    <div class="form-col"><label for="fazendaFiltroBrocamento">Filtrar por Fazenda:</label><select id="fazendaFiltroBrocamento"><option value="">Todas</option></select></div>
                    <div class="form-col"><label for="inicioBrocamento" class="required">Data Início:</label><input type="date" id="inicioBrocamento" /></div>
                    <div class="form-col"><label for="fimBrocamento" class="required">Data Fim:</label><input type="date" id="fimBrocamento" /></div>
                </div>
                <div class="checkbox-group-container">
                    <label>Filtrar por Tipo de Fazenda:</label>
                    <div class="checkbox-group-grid" id="brocaReportFarmTypeFilter">
                        <label class="report-option-item"><input type="checkbox" name="brocaFarmType" value="Própria"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Própria</span></label>
                        <label class="report-option-item"><input type="checkbox" name="brocaFarmType" value="Parceira"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Parceira</span></label>
                        <label class="report-option-item"><input type="checkbox" name="brocaFarmType" value="Fornecedor"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Fornecedor</span></label>
                        <label class="report-option-item"><input type="checkbox" name="brocaFarmType" value="Acionista"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Acionista</span></label>
                        <label class="report-option-item"><input type="checkbox" name="brocaFarmType" value="Arrendatário"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Arrendatário</span></label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="tipoRelatorioBroca">Tipo de Relatório:</label>
                        <select id="tipoRelatorioBroca">
                            <option value="A">Modelo A - Geral</option>
                            <option value="B">Modelo B - Por Fazenda</option>
                        </select>
                    </div>
                </div>
                <div class="botoes-relatorio">
                    <button id="btnPDFBrocamento" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                    <button id="btnExcelBrocamento" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </section>

            <section id="relatorioColheitaCustom" class="tab-content card" aria-label="Relatório Customizado de Colheita" tabindex="0" hidden>
                <h2 style="color: var(--color-purple);"><i class="fas fa-file-invoice"></i> Relatório Customizado de Colheita</h2>
                
                <div class="card" style="border-left-color: var(--color-purple);">
                    <h3><i class="fas fa-filter"></i> 1. Selecione os Filtros</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="planoRelatorioSelect" class="required">Selecione um Plano de Colheita:</label>
                            <select id="planoRelatorioSelect" required></select>
                        </div>
                        <div class="form-col">
                            <label for="tipoRelatorioColheita">Modelo do Relatório:</label>
                            <select id="tipoRelatorioColheita">
                                <option value="detalhado">Detalhado por Fazenda</option>
                                <option value="mensal">Previsão Mensal</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="card" id="colunas-detalhado-container" style="border-left-color: var(--color-purple);">
                    <h3><i class="fas fa-check-square"></i> 2. Selecione as Colunas para o Relatório</h3>
                    <div class="report-options-grid" id="reportOptionsContainer">
                        <label class="report-option-item">
                            <input type="checkbox" data-column="talhoes" checked>
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content"><i class="fas fa-th-large"></i><span>Talhão</span></span>
                        </label>
                        <label class="report-option-item">
                            <input type="checkbox" data-column="variedade" checked>
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content"><i class="fas fa-seedling"></i><span>Variedade</span></span>
                        </label>
                        <label class="report-option-item">
                            <input type="checkbox" data-column="idade" checked>
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content"><i class="fas fa-hourglass-half"></i><span>Idade Média (meses)</span></span>
                        </label>
                        <label class="report-option-item">
                            <input type="checkbox" data-column="atr" checked>
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content"><i class="fas fa-vial"></i><span>ATR</span></span>
                        </label>
                        <label class="report-option-item">
                            <input type="checkbox" data-column="maturador" checked>
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content"><i class="fas fa-flask"></i><span>Maturador Aplicado</span></span>
                        </label>
                        <label class="report-option-item">
                            <input type="checkbox" data-column="diasAplicacao" checked>
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content"><i class="fas fa-calendar-day"></i><span>Dias desde Aplicação</span></span>
                        </label>
                        <label class="report-option-item">
                            <input type="checkbox" data-column="distancia" checked>
                            <span class="checkbox-visual"><i class="fas fa-check"></i></span>
                            <span class="option-content"><i class="fas fa-road"></i><span>Distância (km)</span></span>
                        </label>
                    </div>
                </div>
                
                <div class="card" style="border-left-color: var(--color-purple);">
                    <h3><i class="fas fa-file-export"></i> 3. Gerar Relatório</h3>
                    <div class="botoes-relatorio">
                        <button id="btnGerarRelatorioCustomPDF" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                        <button id="btnGerarRelatorioCustomExcel" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
            </section>

            <section id="relatorioMonitoramento" class="tab-content card" aria-label="Relatório de Monitoramento" tabindex="0" hidden>
                <h2><i class="fas fa-bug"></i> Relatório de Armadilhas</h2>
                <p style="margin-top: -15px; margin-bottom: 20px; color: var(--color-text-light);">Gere relatórios em PDF ou Excel das armadilhas, com filtros por período e fazenda.</p>
                <div class="form-row">
                    <div class="form-col">
                        <label for="monitoramentoTipoRelatorio" class="required">Tipo de Relatório:</label>
                        <select id="monitoramentoTipoRelatorio">
                            <option value="coletadas" selected>Armadilhas Coletadas</option>
                            <option value="instaladas">Armadilhas Instaladas</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="monitoramentoFazendaFiltro">Filtrar por Fazenda:</label><select id="monitoramentoFazendaFiltro"><option value="">Todas</option></select></div>
                    <div class="form-col"><label for="monitoramentoInicio" class="required">Data Início:</label><input type="date" id="monitoramentoInicio" /></div>
                    <div class="form-col"><label for="monitoramentoFim" class="required">Data Fim:</label><input type="date" id="monitoramentoFim" /></div>
                </div>
                <div class="botoes-relatorio">
                    <button id="btnPDFMonitoramento" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                    <button id="btnExcelMonitoramento" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </section>

            <section id="lancamentoPerda" class="tab-content card" aria-label="Lançamento Perda" tabindex="0" hidden>
                <h2><i class="fas fa-dollar-sign"></i> Lançamento Perda</h2>
                <div class="form-row">
                    <div class="form-col"><label for="dataPerda" class="required">Data:</label><input type="date" id="dataPerda" required /></div>
                    <div class="form-col"><label for="codigoPerda" class="required">Fazenda:</label><select id="codigoPerda" required></select></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="talhaoPerda" class="required">Talhão:</label><input type="text" id="talhaoPerda" placeholder="Ex: T12, T15-A" required /><div id="varietyDisplayPerda" class="info-display"></div></div>
                    <div class="form-col"><label for="frenteServico" class="required">Frente de Serviço:</label><input type="text" id="frenteServico" placeholder="Ex: Frente 1" required /></div>
                    <div class="form-col"><label for="turno" class="required">Turno:</label><select id="turno" required><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="frotaEquipamento" class="required">Frota do Equipamento:</label><input type="text" id="frotaEquipamento" placeholder="Ex: 7501" required /></div>
                    <div class="form-col"><label for="matriculaOperador" class="required">Matrícula do Operador:</label><input type="number" id="matriculaOperador" placeholder="Digite a matrícula" required /><div id="operadorNome" class="info-display"></div></div>
                </div>
                <h3>Tipos de Perda (kg)</h3>
                <div class="form-row">
                    <div class="form-col"><label for="canaInteira">Cana Inteira:</label><input type="number" id="canaInteira" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="tolete">Tolete:</label><input type="number" id="tolete" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="toco">Toco:</label><input type="number" id="toco" min="0" placeholder="0" /></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="ponta">Ponta:</label><input type="number" id="ponta" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="estilhaco">Estilhaço:</label><input type="number" id="estilhaco" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="pedaco">Pedaço:</label><input type="number" id="pedaco" min="0" placeholder="0" /></div>
                </div>
                <div class="resultado" id="resultadoPerda"></div>
                <button class="save" type="button" id="btnSalvarPerda"><i class="fas fa-save"></i> Guardar Perda de Cana</button>
            </section>

            <section id="lancamentoCigarrinhaAmostragem" class="tab-content card" aria-label="Lançamento Cigarrinha por Amostragem" tabindex="0" hidden>
                <h2><i class="fas fa-vial"></i> Monitoramento de Cigarrinha (Amostragem)</h2>
                <form id="formCigarrinhaAmostragem">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="dataCigarrinhaAmostragem" class="required">Data:</label>
                            <input type="date" id="dataCigarrinhaAmostragem" required>
                        </div>
                        <div class="form-col">
                            <label for="codigoCigarrinhaAmostragem" class="required">Fazenda:</label>
                            <select id="codigoCigarrinhaAmostragem" required></select>
                        </div>
                        <div class="form-col">
                            <label for="talhaoCigarrinhaAmostragem" class="required">Talhão:</label>
                            <input type="text" id="talhaoCigarrinhaAmostragem" list="talhaoList" required>
                            <div id="varietyDisplayCigarrinhaAmostragem" class="info-display"></div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 10px;">
                        <h3><i class="fas fa-plus-circle"></i> Sub-Amostras</h3>
                        <button type="button" id="addAmostraCigarrinhaAmostragem" class="save" style="max-width: 250px; margin-top: 0;"><i class="fas fa-plus"></i> Adicionar Amostra</button>
                    </div>
                    <div id="amostrasCigarrinhaAmostragemContainer" class="pontos-container">
                        <!-- Cards de amostras serão inseridos aqui -->
                    </div>

                    <div class="form-row">
                        <div class="form-col" style="display: flex; align-items: center; justify-content: flex-start;">
                            <label for="adultoPresenteCigarrinhaAmostragem" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
                                <input type="checkbox" id="adultoPresenteCigarrinhaAmostragem" style="width: auto; transform: scale(1.4);">
                                <span>Presença de Adulto?</span>
                            </label>
                        </div>
                    </div>
                    <div id="resultadoCigarrinhaAmostragem" class="resultado" style="margin-top: 20px;"></div>
                    <button type="button" id="btnSalvarCigarrinhaAmostragem" class="save" style="margin-top: 20px;"><i class="fas fa-save"></i> Guardar Lançamento</button>
                </form>
            </section>

            <section id="lancamentoCigarrinha" class="tab-content card" aria-label="Lançamento Cigarrinha" tabindex="0" hidden>
                <h2><i class="fas fa-leaf"></i> Lançamento Monitoramento de Cigarrinha</h2>
                <div class="form-row">
                    <div class="form-col">
                        <label for="dataCigarrinha" class="required">Data do Levantamento:</label>
                        <input type="date" id="dataCigarrinha" required />
                    </div>
                    <div class="form-col">
                        <label for="codigoCigarrinha" class="required">Fazenda:</label>
                        <select id="codigoCigarrinha" required></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="talhaoCigarrinha" class="required">Talhão:</label>
                        <input type="text" id="talhaoCigarrinha" placeholder="Ex: T12, T15-A" required />
                    </div>
                    <div class="form-col">
                        <label>Variedade:</label>
                        <div id="varietyDisplayCigarrinha" class="info-display" style="margin-top: 8px; padding: 12px 14px; border-radius: var(--border-radius); border: 1px solid var(--color-border); background-color: var(--color-bg); min-height: 45px;"></div>
                    </div>
                </div>
                <h3>Fases (Ninfas)</h3>
                <div class="form-row">
                    <div class="form-col"><label for="fase1Cigarrinha">Fase 1:</label><input type="number" id="fase1Cigarrinha" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="fase2Cigarrinha">Fase 2:</label><input type="number" id="fase2Cigarrinha" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="fase3Cigarrinha">Fase 3:</label><input type="number" id="fase3Cigarrinha" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="fase4Cigarrinha">Fase 4:</label><input type="number" id="fase4Cigarrinha" min="0" placeholder="0" /></div>
                    <div class="form-col"><label for="fase5Cigarrinha">Fase 5:</label><input type="number" id="fase5Cigarrinha" min="0" placeholder="0" /></div>
                </div>
                <div class="form-row">
                    <div class="form-col" style="display: flex; align-items: center; justify-content: flex-start;">
                        <label for="adultoPresenteCigarrinha" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
                            <input type="checkbox" id="adultoPresenteCigarrinha" style="width: auto; transform: scale(1.4);">
                            <span>Presença de Adulto?</span>
                        </label>
                    </div>
                </div>
                <div class="resultado" id="resultadoCigarrinha"></div>
                <button class="save" type="button" id="btnSalvarCigarrinha"><i class="fas fa-save"></i> Guardar Monitoramento</button>
            </section>

            <section id="relatorioPerda" class="tab-content card" aria-label="Relatório Perda" tabindex="0" hidden>
                <h2><i class="fas fa-chart-pie"></i> Relatório de Perda de Cana</h2>
                <div class="form-row">
                    <div class="form-col"><label for="fazendaFiltroPerda">Filtrar por Fazenda:</label><select id="fazendaFiltroPerda"><option value="">Todas</option></select></div>
                    <div class="form-col"><label for="talhaoFiltroPerda">Filtrar por Talhão:</label><input type="text" id="talhaoFiltroPerda" placeholder="Digite Talhão" /></div>
                    <div class="form-col"><label for="operadorFiltroPerda">Filtrar por Operador:</label><select id="operadorFiltroPerda"><option value="">Todos</option></select></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="frenteFiltroPerda">Filtrar por Frente de Serviço:</label><input type="text" id="frenteFiltroPerda" placeholder="Digite Frente de Serviço" /></div>
                    <div class="form-col"><label for="inicioPerda" class="required">Data Início:</label><input type="date" id="inicioPerda" /></div>
                    <div class="form-col"><label for="fimPerda" class="required">Data Fim:</label><input type="date"id="fimPerda" /></div>
                </div>
                 <div class="checkbox-group-container">
                    <label>Filtrar por Tipo de Fazenda:</label>
                    <div class="checkbox-group-grid" id="perdaReportFarmTypeFilter">
                        <label class="report-option-item"><input type="checkbox" name="perdaFarmType" value="Própria"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Própria</span></label>
                        <label class="report-option-item"><input type="checkbox" name="perdaFarmType" value="Parceira"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Parceira</span></label>
                        <label class="report-option-item"><input type="checkbox" name="perdaFarmType" value="Fornecedor"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Fornecedor</span></label>
                        <label class="report-option-item"><input type="checkbox" name="perdaFarmType" value="Acionista"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Acionista</span></label>
                        <label class="report-option-item"><input type="checkbox" name="perdaFarmType" value="Arrendatário"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Arrendatário</span></label>
                    </div>
                </div>
                <div class="form-row"><div class="form-col"><label for="tipoRelatorioPerda">Tipo de Relatório:</label><select id="tipoRelatorioPerda"><option value="A">Modelo A - Resumido</option><option value="B">Modelo B - Detalhado</option></select></div></div>
                <div class="botoes-relatorio">
                    <button id="btnPDFPerda" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                    <button id="btnExcelPerda" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </section>

            <section id="relatorioCigarrinha" class="tab-content card" aria-label="Relatório Cigarrinha" tabindex="0" hidden>
                <h2><i class="fas fa-leaf"></i> Relatório de Monitoramento de Cigarrinha</h2>
                <div class="form-row">
                    <div class="form-col"><label for="fazendaFiltroCigarrinha">Filtrar por Fazenda:</label><select id="fazendaFiltroCigarrinha"><option value="">Todas</option></select></div>
                    <div class="form-col"><label for="inicioCigarrinha" class="required">Data Início:</label><input type="date" id="inicioCigarrinha" /></div>
                    <div class="form-col"><label for="fimCigarrinha" class="required">Data Fim:</label><input type="date" id="fimCigarrinha" /></div>
                </div>
                <div class="botoes-relatorio">
                    <button id="btnPDFCigarrinha" type="button" style="height: 40px;"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                    <button id="btnExcelCigarrinha" type="button" style="height: 40px;"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </section>

<section id="relatorioCigarrinhaAmostragem" class="tab-content card" aria-label="Relatório de Cigarrinha de Amostragem" tabindex="0" hidden>
    <h2><i class="fas fa-file-invoice"></i> Relatório de Monitoramento de Cigarrinha (Amostragem)</h2>
    <div class="form-row">
        <div class="form-col">
            <label for="tipoRelatorioCigarrinhaAmostragem">Tipo de Relatório:</label>
            <select id="tipoRelatorioCigarrinhaAmostragem">
                <option value="detalhado">Detalhado (por amostra)</option>
                <option value="resumido">Resumido (por talhão)</option>
                <option value="final">Modelo Final</option>
            </select>
        </div>
        <div class="form-col"><label for="fazendaFiltroCigarrinhaAmostragem">Filtrar por Fazenda:</label><select id="fazendaFiltroCigarrinhaAmostragem"><option value="">Todas</option></select></div>
    </div>
    <div class="form-row">
        <div class="form-col"><label for="inicioCigarrinhaAmostragem" class="required">Data Início:</label><input type="date" id="inicioCigarrinhaAmostragem" /></div>
        <div class="form-col"><label for="fimCigarrinhaAmostragem" class="required">Data Fim:</label><input type="date" id="fimCigarrinhaAmostragem" /></div>
    </div>
    <div class="botoes-relatorio">
        <button id="btnPDFCigarrinhaAmostragem" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
        <button id="btnExcelCigarrinhaAmostragem" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
    </div>
</section>

            <section id="gerenciarLancamentos" class="tab-content card" aria-label="Gerenciar Lançamentos" tabindex="0" hidden>
                <h2><i class="fas fa-edit"></i> Gerenciar Lançamentos</h2>
                <p>Selecione um lançamento para editar ou excluir.</p>
                <div class="card" style="border-left-color: var(--color-warning); margin-bottom: 20px;">
                    <h3><i class="fas fa-filter"></i> Filtros</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="manageDataType">Tipo de Dado:</label>
                            <select id="manageDataType">
                                <option value="apontamentoPlantio">Apontamento de Plantio</option>
                                <option value="brocamento">Brocamento</option>
                                <option value="perda">Perda de Cana</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label for="manageStartDate">Data Início:</label>
                            <input type="date" id="manageStartDate">
                        </div>
                        <div class="form-col">
                            <label for="manageEndDate">Data Fim:</label>
                            <input type="date" id="manageEndDate">
                        </div>
                    </div>
                    <button id="btnApplyManageFilters" class="save" style="max-width: 200px;"><i class="fas fa-filter"></i> Aplicar Filtros</button>
                </div>
                <div id="listaGerenciamento" tabindex="0"></div>
            </section>

            <section id="cadastros" class="tab-content card" aria-label="Cadastros" tabindex="0" hidden>
                <h2><i class="fas fa-book"></i> Cadastros Gerais</h2>

                <div id="superAdminFarmCreation" class="card" style="display: none; border-left-color: var(--color-purple); margin-bottom: 20px;">
                    <h4><i class="fas fa-user-shield"></i> Ação como Super Admin</h4>
                    <p>Para criar ou importar novas fazendas, por favor, selecione a empresa de destino.</p>
                    <label for="adminTargetCompanyFarms" class="required">Empresa Alvo:</label>
                    <select id="adminTargetCompanyFarms" required></select>
                </div>

                <div class="card" style="border-left-color: var(--color-purple);">
                    <h3><i class="fas fa-upload"></i> Importar Cadastros via CSV</h3>
                    <p>Faça o upload de um ficheiro CSV com todos os dados de fazendas e talhões. O sistema irá <strong>atualizar</strong> os cadastros existentes e <strong>adicionar</strong> novos, sem criar duplicatas.</p>
                    <div class="upload-area" id="csvUploadArea">
                        <i class="fas fa-file-csv fa-2x" style="color: var(--color-primary);"></i>
                        <p>Clique ou arraste um ficheiro CSV aqui</p>
                    </div>
                    <div class="download-progress-container" id="farm-import-progress" style="display: none; margin-top: 15px;">
                        <p class="download-progress-text"></p>
                        <progress class="download-progress-bar" value="0" max="100"></progress>
                    </div>
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                    <button id="btnDownloadCsvTemplate" class="save" style="max-width: 300px; margin-top: 15px; background: var(--color-info);"><i class="fas fa-download"></i> Baixar Modelo CSV</button>
                    <small class="csv-format-info">Formato: Cód;FAZENDA;TIPO;TALHÃO;Área;TCH;Variedade;Corte;Distancia;DataUltimaColheita</small>
                </div>

                <div class="card" style="border-left-color: var(--color-purple); margin-top: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                        <h3><i class="fas fa-tractor"></i> Gerir Fazendas e Talhões (Manual)</h3>
                        <button id="btnDeleteAllFarms" class="btn-excluir" style="margin-left: 0;"><i class="fas fa-exclamation-triangle"></i> Excluir Todas</button>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><label for="farmCode" class="required">Código da Fazenda:</label><input type="number" id="farmCode" placeholder="Ex: 4012"></div>
                        <div class="form-col"><label for="farmName" class="required">Nome da Fazenda:</label><input type="text" id="farmName" placeholder="Ex: FAZ. LAGOA CERCADA"></div>
                    </div>
                    <div class="checkbox-group-container">
                        <label>Tipo da Fazenda:</label>
                        <div class="checkbox-group-grid" id="farmTypeCheckboxes">
                            <label class="report-option-item"><input type="checkbox" name="farmType" value="Própria"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Própria</span></label>
                            <label class="report-option-item"><input type="checkbox" name="farmType" value="Parceira"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Parceira</span></label>
                            <label class="report-option-item"><input type="checkbox" name="farmType" value="Fornecedor"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Fornecedor</span></label>
                            <label class="report-option-item"><input type="checkbox" name="farmType" value="Acionista"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Acionista</span></label>
                            <label class="report-option-item"><input type="checkbox" name="farmType" value="Arrendatário"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Arrendatário</span></label>
                        </div>
                    </div>
                    <button id="btnSaveFarm" class="save" style="max-width: 250px;"><i class="fas fa-plus-circle"></i> Guardar Fazenda</button>
                    <hr style="margin: 20px 0;">
                    <label for="farmSelect">Selecione uma Fazenda para gerir os seus talhões:</label>
                    <select id="farmSelect"></select>
                    <div id="talhaoManagementContainer" style="display:none;">
                        <h4>Talhões da Fazenda <span id="selectedFarmName"></span> <span id="selectedFarmTypes"></span></h4>
                        <div id="talhaoList" class="table-responsive"></div>
                        <h5 style="margin-top:20px;">Adicionar/Editar Talhão</h5>
                        <input type="hidden" id="talhaoId">
                        <div class="form-row">
                            <div class="form-col"><label for="talhaoName" class="required">Nome do Talhão:</label><input type="text" id="talhaoName"></div>
                            <div class="form-col"><label for="talhaoArea" class="required">Área (ha):</label><input type="number" id="talhaoArea"></div>
                            <div class="form-col"><label for="talhaoTCH" class="required">TCH (ton/ha):</label><input type="number" id="talhaoTCH"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-col"><label for="talhaoProducao" class="required">Produção (ton):</label><input type="number" id="talhaoProducao" readonly></div>
                            <div class="form-col"><label for="talhaoCorte">Corte:</label><input type="number" id="talhaoCorte" min="1" placeholder="Ex: 1"></div>
                            <div class="form-col"><label for="talhaoVariedade">Variedade:</label><input type="text" id="talhaoVariedade"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-col"><label for="talhaoDistancia">Distância (km):</label><input type="number" id="talhaoDistancia"></div>
                            <div class="form-col"><label for="talhaoUltimaColheita">Data da Última Colheita:</label><input type="date" id="talhaoUltimaColheita"></div>
                        </div>
                        <button id="btnSaveTalhao" class="save" style="max-width: 250px;"><i class="fas fa-save"></i> Guardar Talhão</button>
                    </div>
                </div>
            </section>

            <section id="gerenciarUsuarios" class="tab-content card" aria-label="Gerir Utilizadores" tabindex="0" hidden>
                <h2><i class="fas fa-users-cog"></i> Gerir Utilizadores</h2>
                <div id="superAdminUserCreation" class="card" style="display: none; border-left-color: var(--color-purple); margin-bottom: 20px;">
                    <h4><i class="fas fa-user-shield"></i> Ação como Super Admin</h4>
                    <p>Para criar um novo utilizador, por favor, selecione a empresa à qual ele pertencerá.</p>
                    <label for="adminTargetCompanyUsers" class="required">Empresa Alvo:</label>
                    <select id="adminTargetCompanyUsers" required></select>
                </div>
                <h3><i class="fas fa-user-plus"></i> Criar Novo Utilizador</h3>
                <div class="form-row">
                    <div class="form-col"><label for="newUserUsername" class="required">Email do Utilizador:</label><input id="newUserUsername" type="email" required /></div>
                    <div class="form-col"><label for="newUserPassword" class="required">Senha:</label><input id="newUserPassword" type="password" required /></div>
                    <div class="form-col"><label for="newUserRole">Perfil:</label><select id="newUserRole"><option value="user">Utilizador</option><option value="admin">Administrador</option><option value="supervisor">Supervisor</option><option value="tecnico">Técnico</option><option value="colaborador">Colaborador</option></select></div>
                </div>
                <fieldset style="margin-top: 20px; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 15px;">
                    <legend>Permissões</legend>
                    <div class="permission-grid">
                        <!-- As permissões serão injetadas aqui via JS -->
                    </div>
                </fieldset>
                <button class="save" id="btnCreateUser" style="max-width: 250px; margin-top: 25px;"><i class="fas fa-user-plus"></i> Criar Utilizador</button>
                <h3><i class="fas fa-users"></i> Utilizadores Cadastrados</h3>
                <div id="usersList"></div>
            </section>

            <section id="gerenciarEmpresas" class="tab-content card" aria-label="Gerir Empresas" tabindex="0" hidden>
                <h2><i class="fas fa-building"></i> Gerir Empresas (Super Admin)</h2>
                <div class="card" style="border-left-color: var(--color-danger);">
                    <h3><i class="fas fa-plus-circle"></i> Criar Nova Empresa e Admin</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="newCompanyName" class="required">Nome da Empresa:</label>
                            <input id="newCompanyName" type="text" required />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="newCompanyAdminEmail" class="required">Email do Administrador da Empresa:</label>
                            <input id="newCompanyAdminEmail" type="email" required />
                        </div>
                        <div class="form-col">
                            <label for="newCompanyAdminPassword" class="required">Senha do Administrador:</label>
                            <input id="newCompanyAdminPassword" type="password" required />
                        </div>
                    </div>
                    <div class="checkbox-group-container" style="margin-top: 20px;">
                        <label class="required">Módulos Subscritos:</label>
                        <div class="checkbox-group-grid" id="newCompanyModules">
                            <!-- Os módulos serão gerados aqui pelo app.js -->
                        </div>
                    </div>
                    <button class="save" id="btnCreateCompany" style="max-width: 300px; margin-top: 25px; background: var(--color-danger);"><i class="fas fa-plus-circle"></i> Criar Empresa</button>
                </div>
                <h3><i class="fas fa-building"></i> Empresas Cadastradas</h3>
                <div id="companiesList" class="table-responsive"></div>

                <div class="card" style="margin-top: 30px; border-left-color: var(--color-warning);">
                    <h3><i class="fas fa-database"></i> Ferramentas de Dados</h3>
                    <p>Use esta ferramenta para associar todos os dados antigos (criados antes do sistema de empresas) a uma empresa específica. Esta é uma operação de uso único e deve ser usada com cuidado.</p>
                    <button id="btnMigrateOldData" class="save" style="max-width: 300px; background: var(--color-warning);"><i class="fas fa-cogs"></i> Iniciar Migração de Dados</button>
                </div>

                <div id="globalFeatureFlagCard" class="card" style="margin-top: 30px; border-left-color: var(--color-ai);">
                    <h3><i class="fas fa-cogs"></i> Controlo Global de Funcionalidades</h3>
                    <p>Ative ou desative funcionalidades para **todos os utilizadores**. O Super Admin sempre terá acesso a todas as funcionalidades para testes.</p>
                    <div id="globalFeaturesGrid" class="permission-grid">
                        <!-- Feature flags globais serão injetadas aqui -->
                    </div>
                    <button id="btnSaveGlobalFeatures" class="save" style="max-width: 300px; margin-top: 25px; background: var(--color-ai);"><i class="fas fa-save"></i> Guardar Alterações Globais</button>
                </div>
            </section>

            <section id="cadastrarPessoas" class="tab-content card" aria-label="Cadastrar Pessoas" tabindex="0" hidden>
                <h2><i class="fas fa-id-card"></i> Cadastro de Pessoas</h2>
                <div class="card" style="border-left-color: var(--color-purple);">
                    <h3><i class="fas fa-upload"></i> Importar Pessoas via CSV</h3>
                    <p>Faça o upload de um ficheiro CSV com matrículas e nomes. O sistema irá <strong>atualizar</strong> os nomes existentes e <strong>adicionar</strong> novos, sem criar duplicatas.</p>
                    <div class="upload-area" id="personnelCsvUploadArea">
                        <i class="fas fa-file-csv fa-2x" style="color: var(--color-info);"></i>
                        <p>Clique ou arraste um ficheiro CSV aqui</p>
                    </div>
                    <input type="file" id="personnelCsvInput" accept=".csv" style="display: none;">
                    <button id="btnDownloadPersonnelCsvTemplate" class="save" style="max-width: 300px; margin-top: 15px; background: var(--color-info);"><i class="fas fa-download"></i> Baixar Modelo CSV</button>
                    <small>Formato esperado: Matricula;Nome</small> 
                </div>
                <div class="card" style="border-left-color: var(--color-info); margin-top: 30px;">
                    <h3><i class="fas fa-user-plus"></i> Adicionar/Editar Pessoa (Manual)</h3>
                    <input type="hidden" id="personnelId">
                    <div class="form-row">
                        <div class="form-col"><label for="personnelMatricula" class="required">Matrícula:</label><input type="number" id="personnelMatricula" placeholder="Ex: 102030"></div>
                        <div class="form-col"><label for="personnelName" class="required">Nome Completo:</label><input type="text" id="personnelName" placeholder="Ex: João da Silva"></div>
                    </div>
                    <button id="btnSavePersonnel" class="save" style="max-width: 250px;"><i class="fas fa-save"></i> Guardar Pessoa</button>
                </div>
                    <h3><i class="fas fa-users"></i> Pessoas Cadastradas</h3>
                <div id="personnelList" class="table-responsive"></div>
            </section>
            
            <section id="configuracoesEmpresa" class="tab-content card" aria-label="Configurações da Empresa" tabindex="0" hidden>
                <h2><i class="fas fa-building"></i> Configurações da Empresa</h2>
                <div class="card" style="border-left-color: var(--color-purple);">
                    <h3><i class="fas fa-image"></i> Logotipo da Empresa</h3>
                    <p>Faça o upload do logotipo que aparecerá no cabeçalho dos relatórios. Use uma imagem com fundo transparente (PNG) para melhores resultados.</p>
                    <div class="upload-area" id="logoUploadArea">
                        <i class="fas fa-upload fa-2x" style="color: var(--color-primary);"></i>
                        <p>Clique ou arraste o logotipo aqui</p>
                        <img id="logoPreview" src="#" alt="Pré-visualização do Logo" style="display: none;" />
                    </div>
                    <input type="file" id="logoInput" accept="image/png, image/jpeg" style="display: none;">
                    <button id="removeLogoBtn" class="btn-secondary" style="background: var(--color-danger); max-width: 200px; display: none;"><i class="fas fa-trash"></i> Remover Logo</button>
                </div>
                
                <div class="card" style="border-left-color: var(--color-success); margin-top: 30px;">
                    <h3><i class="fas fa-calculator"></i> Configurações de Cálculo</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="cigarrinhaCalcMethod">Método de Cálculo (Cigarrinha Amostragem):</label>
                            <select id="cigarrinhaCalcMethod">
                                <option value="5">Soma das Fases ÷ 5</option>
                                <option value="10">Soma das Fases ÷ 10</option>
                            </select>
                            <small>Define o divisor usado no cálculo do resultado do monitoramento.</small>
                        </div>
                    </div>
                    <div class="button-group" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                         <button id="btnSaveCalcMethod" class="save" style="max-width: 250px; margin-top: 0;"><i class="fas fa-save"></i> Guardar Alteração</button>
                         <button id="btnViewCalcHistory" class="btn-secondary" style="max-width: 250px; margin-top: 0;"><i class="fas fa-history"></i> Ver Histórico</button>
                    </div>
                </div>

                <div class="card" style="border-left-color: var(--color-success); margin-top: 30px;">
                    <h3><i class="fas fa-bullseye"></i> Metas de Plantio por Cultura</h3>
                    <p>Defina as metas <strong>total (ha)</strong> e <strong>diária (ha/dia)</strong> para cada cultura. Estes valores serão usados nos KPIs e gráficos do dashboard de plantio.</p>
                    <div id="planting-goals-container" style="margin-top: 15px;">
                        <!-- Inputs para as metas por cultura serão inseridos aqui dinamicamente -->
                    </div>
                     <div class="button-group" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                         <button id="btnSavePlantingGoals" class="save" style="max-width: 250px; margin-top: 0;"><i class="fas fa-save"></i> Guardar Metas</button>
                    </div>
                </div>

                <div class="card" style="border-left-color: var(--color-info); margin-top: 30px;">
                    <h3><i class="fas fa-map"></i> Contornos dos Talhões (Shapefile)</h3>
                    <p>Importe os limites geográficos das suas fazendas e talhões. Faça o upload de um arquivo <strong>.zip</strong> contendo os arquivos .shp, .shx e .dbf.</p>
                    <div class="upload-area" id="shapefileUploadArea">
                        <i class="fas fa-file-archive fa-2x" style="color: var(--color-info);"></i>
                        <p>Clique ou arraste um arquivo .zip aqui</p>
                    </div>
                    <input type="file" id="shapefileInput" accept=".zip" style="display: none;">
                </div>

                <div class="card" style="border-left-color: var(--color-danger); margin-top: 30px;">
                    <h3><i class="fas fa-broom"></i> Limpeza de Dados</h3>
                    <p>Use esta ferramenta para remover armadilhas duplicadas do sistema, mantendo apenas a mais recente para cada talhão. Esta ação não pode ser desfeita.</p>
                    <button id="btnCleanDuplicateTraps" class="save" style="max-width: 300px; background: var(--color-danger);"><i class="fas fa-broom"></i> Limpar Armadilhas Duplicadas</button>
                </div>

                <div class="card" style="border-left-color: var(--color-purple); margin-top: 30px;">
                    <h3><i class="fas fa-history"></i> Gerir Histórico de Dados para Cálculo de ATR</h3>
                    <p>Faça o upload de um relatório com o histórico de colheitas para alimentar o cálculo automático de ATR. O arquivo deve seguir o modelo fornecido.</p>
                    <div class="upload-area" id="historicalReportUploadArea">
                        <i class="fas fa-file-alt fa-2x" style="color: var(--color-purple);"></i>
                        <p>Clique ou arraste o seu relatório para aqui</p>
                    </div>
                    <input type="file" id="historicalReportInput" accept=".csv,.txt,.xlsx" style="display: none;">
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center;">
                         <button id="btnDownloadHistoricalTemplate" class="save" style="max-width: 300px; margin-top: 0; background: var(--color-info);"><i class="fas fa-download"></i> Baixar Modelo</button>
                         <button id="btnDeleteHistoricalData" class="btn-excluir" style="width: 100%; max-width: 300px; margin-top: 0; justify-content: center;"><i class="fas fa-trash"></i> Apagar Todo o Histórico</button>
                    </div>
                </div>

                <div class="card" style="border-left-color: var(--color-info); margin-top: 30px;">
                    <h3><i class="fas fa-sync-alt"></i> Sincronização Global dos Planos de Colheita</h3>
                    <p>Importe relatórios do seu sistema principal para manter <strong>todos os planos de colheita</strong> sempre atualizados com a operação real.</p>

                    <div class="card" style="margin-top: 25px; border-left-color: var(--color-warning);">
                        <h4><i class="fas fa-tasks"></i> 1. Relatório de Colheita em Andamento</h4>
                        <p>Importe um CSV com dados de colheita parcial. O sistema irá subtrair os valores de área e produção dos talhões correspondentes em todos os planos.</p>
                        <div class="upload-area" id="harvestReportProgressUploadArea">
                            <i class="fas fa-file-csv fa-2x" style="color: var(--color-warning);"></i>
                            <p>Clique ou arraste o relatório de <strong>andamento</strong> aqui</p>
                        </div>
                        <input type="file" id="harvestReportProgressInput" accept=".csv" style="display: none;">
                        <button id="btnDownloadProgressTemplate" class="save" style="max-width: 300px; margin-top: 15px; background: var(--color-warning);"><i class="fas fa-download"></i> Baixar Modelo (Andamento)</button>
                        <small class="csv-format-info">Formato: CodigoFazenda;Talhao;AreaColhida;ProducaoColhida</small>
                    </div>

                    <div class="card" style="margin-top: 25px; border-left-color: var(--color-success);">
                        <h4><i class="fas fa-check-circle"></i> 2. Relatório de Talhões Encerrados</h4>
                        <p>Importe um CSV com a lista de talhões já finalizados. O sistema irá marcá-los como 'Encerrado' em todos os planos de colheita onde eles aparecem.</p>
                        <div class="upload-area" id="harvestReportClosedUploadArea">
                            <i class="fas fa-file-csv fa-2x" style="color: var(--color-success);"></i>
                            <p>Clique ou arraste o relatório de <strong>encerrados</strong> aqui</p>
                        </div>
                        <input type="file" id="harvestReportClosedInput" accept=".csv" style="display: none;">
                        <button id="btnDownloadClosedTemplate" class="save" style="max-width: 300px; margin-top: 15px; background: var(--color-success);"><i class="fas fa-download"></i> Baixar Modelo (Encerrados)</button>
                        <small class="csv-format-info">Formato: CodigoFazenda;Talhao</small>
                    </div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--color-border); text-align: right;">
                    <button id="btnSaveCompanySettings" class="save" style="max-width: 300px;"><i class="fas fa-save"></i> Guardar Todas as Configurações</button>
                </div>
            </section>

            <section id="syncHistory" class="tab-content card" aria-label="Histórico de Sincronização" tabindex="0" hidden>
                <h2><i class="fas fa-history"></i> Histórico de Sincronização</h2>
                <p style="margin-top: -15px; margin-bottom: 20px; color: var(--color-text-light);">Veja os detalhes de cada tentativa de sincronização de dados.</p>
                <div id="syncHistoryList">
                    <!-- Logs de sincronização serão inseridos aqui -->
                </div>
            </section>

            <section id="relatorioPlantio" class="tab-content card" aria-label="Relatórios de Plantio" tabindex="0" hidden>
                <h2><i class="fas fa-chart-bar"></i> Relatórios de Plantio</h2>
                <div class="form-row">
                    <div class="form-col">
                        <label for="plantioRelatorioFrente">Filtrar por Frente de Plantio:</label>
                        <select id="plantioRelatorioFrente">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label for="plantioRelatorioCultura">Filtrar por Cultura:</label>
                        <select id="plantioRelatorioCultura">
                            <option value="">Todas</option>
                            <option value="Cana-de-açúcar">Cana-de-açúcar</option>
                            <option value="Soja">Soja</option>
                            <option value="Milho">Milho</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="plantioRelatorioInicio" class="required">Data Início:</label>
                        <input type="date" id="plantioRelatorioInicio" />
                    </div>
                    <div class="form-col">
                        <label for="plantioRelatorioFim" class="required">Data Fim:</label>
                        <input type="date" id="plantioRelatorioFim" />
                    </div>
                </div>
                <div class="checkbox-group-container">
                    <label>Filtrar por Tipo de Fazenda:</label>
                    <div class="checkbox-group-grid" id="plantioReportFarmTypeFilter">
                        <label class="report-option-item"><input type="checkbox" name="plantioFarmType" value="Própria"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Própria</span></label>
                        <label class="report-option-item"><input type="checkbox" name="plantioFarmType" value="Parceira"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Parceira</span></label>
                        <label class="report-option-item"><input type="checkbox" name="plantioFarmType" value="Fornecedor"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Fornecedor</span></label>
                        <label class="report-option-item"><input type="checkbox" name="plantioFarmType" value="Acionista"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Acionista</span></label>
                        <label class="report-option-item"><input type="checkbox" name="plantioFarmType" value="Arrendatário"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Arrendatário</span></label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="tipoRelatorioPlantio">Tipo de Relatório:</label>
                        <select id="tipoRelatorioPlantio">
                            <option value="fazenda">Por Fazenda</option>
                            <option value="talhao">Geral</option>
                        </select>
                    </div>
                </div>
                <div class="botoes-relatorio">
                    <button id="btnPDFPlantio" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                    <button id="btnExcelPlantio" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </section>

            <section id="apontamentoPlantio" class="tab-content card" aria-label="Apontamento Diário de Plantio" tabindex="0" hidden>
                <h2><i class="fas fa-seedling"></i> Apontamento Diário de Plantio</h2>
                <form id="formApontamentoPlantio">
                            <input type="hidden" id="plantioEntryId">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="plantioFrente" class="required">Frente de Plantio:</label>
                            <select id="plantioFrente" required></select>
                        </div>
                        <div class="form-col">
                            <label for="plantioProvider">Prestador:</label>
                            <input type="text" id="plantioProvider" readonly>
                        </div>
                        <div class="form-col">
                            <label for="plantioCulture" class="required">Cultura:</label>
                            <select id="plantioCulture" required>
                                <option value="Cana-de-açúcar">Cana-de-açúcar</option>
                                <option value="Soja">Soja</option>
                                <option value="Milho">Milho</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="plantioLeaderId" class="required">Matrícula do Líder:</label>
                            <input type="text" id="plantioLeaderId" required>
                            <div id="plantioLeaderName" class="info-display"></div>
                        </div>
                        <div class="form-col">
                            <label for="plantioFarmName" class="required">Nome da Fazenda:</label>
                            <select id="plantioFarmName" required></select>
                        </div>
                        <div class="form-col">
                            <label for="plantioDate" class="required">Data da Operação:</label>
                            <input type="date" id="plantioDate" required>
                        </div>
                        <div class="form-col">
                            <label for="plantioChuva">Chuva (mm):</label>
                            <input type="number" id="plantioChuva" placeholder="Ex: 10">
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 10px;">
                        <h3><i class="fas fa-plus-circle"></i> Lançamentos de Plantio</h3>
                        <button type="button" id="addPlantioRecord" class="save" style="max-width: 250px; margin-top: 0;"><i class="fas fa-plus"></i> Adicionar Lançamento</button>
                    </div>
                    <div id="plantioRecordsContainer" class="pontos-container">
                        <!-- Cards de lançamentos serão inseridos aqui -->
                    </div>

                    <div id="plantioInfo" class="resultado" style="margin-top: 10px;"></div>
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-col">
                            <label for="plantioObs">Observações:</label>
                            <textarea id="plantioObs" placeholder="Adicione observações..."></textarea>
                        </div>
                    </div>

                    <div class="resultado" id="totalPlantedArea" style="margin-top: 20px;"></div>
                    <button type="button" id="btnSaveApontamentoPlantio" class="save" style="margin-top: 20px;"><i class="fas fa-save"></i> Guardar Apontamento</button>
                </form>
            </section>

            <section id="frenteDePlantio" class="tab-content card" aria-label="Frente de Plantio" tabindex="0" hidden>
                <h2><i class="fas fa-tractor"></i> Cadastro de Frente de Plantio</h2>
                <div class="card" style="border-left-color: var(--color-purple);">
                    <h3><i class="fas fa-plus-circle"></i> Adicionar/Editar Frente de Plantio</h3>
                    <input type="hidden" id="frenteDePlantioId">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="frenteDePlantioName" class="required">Nome da Frente:</label>
                            <input type="text" id="frenteDePlantioName" placeholder="Ex: Frente 01">
                        </div>
                        <div class="form-col">
                            <label for="frenteDePlantioProvider" class="required">Prestador Vinculado:</label>
                            <input type="text" id="frenteDePlantioProvider" placeholder="Ex: Agro Sementes">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="frenteDePlantioObs">Observação:</label>
                            <textarea id="frenteDePlantioObs" placeholder="Detalhes adicionais..."></textarea>
                        </div>
                    </div>
                    <button id="btnSaveFrenteDePlantio" class="save" style="max-width: 250px;"><i class="fas fa-save"></i> Guardar Frente</button>
                </div>
                <h3><i class="fas fa-list-ul"></i> Frentes Cadastradas</h3>
                <div id="frenteDePlantioList" class="table-responsive"></div>
            </section>

            <section id="lancamentoClima" class="tab-content card" aria-label="Apontamento Climatológico" tabindex="0" hidden>
                <h2><i class="fas fa-cloud"></i> Apontamento Climatológico</h2>
                <form id="formLancamentoClima">
                    <input type="hidden" id="climaEntryId">
                    <div class="form-row">
                        <div class="form-col">
                            <label for="climaData" class="required">Data da Coleta:</label>
                            <input type="date" id="climaData" required>
                        </div>
                        <div class="form-col">
                            <label for="climaFazenda" class="required">Fazenda:</label>
                            <select id="climaFazenda" required></select>
                        </div>
                        <div class="form-col">
                            <label for="climaTalhao" class="required">Talhão:</label>
                            <select id="climaTalhao" required></select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="climaTempMax" class="required">Temperatura Máxima (°C):</label>
                            <input type="number" id="climaTempMax" placeholder="Ex: 32" required>
                        </div>
                        <div class="form-col">
                            <label for="climaTempMin" class="required">Temperatura Mínima (°C):</label>
                            <input type="number" id="climaTempMin" placeholder="Ex: 18" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="climaUmidade" class="required">Umidade Relativa (%):</label>
                            <input type="number" id="climaUmidade" placeholder="Ex: 65" required>
                        </div>
                        <div class="form-col">
                            <label for="climaPluviosidade" class="required">Pluviosidade (mm):</label>
                            <input type="number" id="climaPluviosidade" placeholder="Ex: 15" required>
                        </div>
                        <div class="form-col">
                            <label for="climaVento" class="required">Velocidade do Vento (km/h):</label>
                            <input type="number" id="climaVento" placeholder="Ex: 12" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label for="climaObs">Observações:</label>
                            <textarea id="climaObs" placeholder="Adicione observações..."></textarea>
                        </div>
                    </div>
                    <button type="button" id="btnSaveLancamentoClima" class="save" style="margin-top: 20px;"><i class="fas fa-save"></i> Guardar Apontamento</button>
                </form>
            </section>

            <section id="relatorioClima" class="tab-content card" aria-label="Relatório Climatológico" tabindex="0" hidden>
                <h2><i class="fas fa-file-pdf"></i> Relatório Climatológico</h2>
                <div class="form-row">
                    <div class="form-col"><label for="climaRelatorioFazenda">Filtrar por Fazenda:</label><select id="climaRelatorioFazenda"><option value="">Todas</option></select></div>
                    <div class="form-col"><label for="climaRelatorioInicio" class="required">Data Início:</label><input type="date" id="climaRelatorioInicio" /></div>
                    <div class="form-col"><label for="climaRelatorioFim" class="required">Data Fim:</label><input type="date" id="climaRelatorioFim" /></div>
                </div>
                <div class="botoes-relatorio">
                    <button id="btnPDFClima" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                    <button id="btnExcelClima" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                </div>
            </section>

        </main>
        
        <div id="monitoramentoAereo-container" class="tab-content">
            <div id="map-container" class="loading">
                <div id="map"></div>
                <div class="map-search-container">
                    <input type="text" id="map-farm-search-input" placeholder="Pesquisar fazenda...">
                    <button id="map-farm-search-btn" class="map-control-btn" title="Pesquisar Fazenda">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="map-controls">
                    <button id="btnCenterMap" class="map-control-btn" title="Centralizar em Mim">
                        <i class="fas fa-location-arrow"></i>
                    </button>
                     <button id="btnHistory" class="map-control-btn" title="Histórico de Rastreio">
                        <i class="fas fa-history"></i>
                    </button>
                    <button id="btnToggleRiskView" class="map-control-btn" title="Visualização de Risco" style="display: none;">
                        <i class="fas fa-biohazard"></i>
                    </button>
                    <button id="btnAddTrap" class="map-control-btn" title="Adicionar Armadilha no Local Atual">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="talhao-info-box" class="info-box">
                    <button id="close-info-box" class="modal-close-btn">&times;</button>
                    <div id="talhao-info-box-content"></div>
                </div>
                <div id="trap-info-box" class="info-box">
                    <button id="close-trap-info-box" class="modal-close-btn">&times;</button>
                    <div id="trap-info-box-content"></div>
                </div>
            </div>
        </div>

        <!-- MODAIS -->
        <div id="trapPlacementModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Instalar Nova Armadilha</h2>
                    <button id="trapPlacementModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <div id="trapPlacementModalBody" style="min-height: 100px; display: flex; align-items: center; justify-content: center;">
                    <!-- O conteúdo será preenchido via JS -->
                </div>
                <div class="modal-footer">
                    <button id="trapPlacementModalCancelBtn" class="btn-secondary">Cancelar</button>
                    <button id="trapPlacementModalManualBtn" class="btn-secondary" style="background: var(--color-warning);">Selecionar Manualmente</button>
                    <button id="trapPlacementModalConfirmBtn" class="save">Confirmar</button>
                </div>
            </div>
        </div>

        <div id="userEditModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="userEditModalTitle">Editar Utilizador</h2>
                    <button id="userEditModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <input type="hidden" id="editingUserId">
                <div class="form-row">
                    <div class="form-col">
                        <label for="editUserUsername">Email do Utilizador:</label>
                        <input id="editUserUsername" type="text" disabled style="background: #eee;" />
                    </div>
                    <div class="form-col">
                        <label for="editUserRole">Perfil:</label>
                        <select id="editUserRole">
                            <option value="user">Utilizador</option>
                            <option value="admin">Administrador</option>
                            <option value="supervisor">Supervisor</option>
                            <option value="tecnico">Técnico</option>
                            <option value="colaborador">Colaborador</option>
                        </select>
                    </div>
                </div>
                <fieldset style="margin-top: 20px; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 15px;">
                    <legend>Permissões</legend>
                    <div id="editUserPermissionGrid" class="permission-grid">
                        <!-- Permissões serão injetadas aqui via JS -->
                    </div>
                </fieldset>
                <div class="modal-footer">
                    <div class="danger-zone">
                            <button id="btnResetPassword" class="btn-secondary" style="background: var(--color-warning);"><i class="fas fa-key"></i> Redefinir Senha</button>
                            <button id="btnDeleteUser" class="btn-secondary" style="background: var(--color-danger);"><i class="fas fa-trash"></i> Excluir Utilizador</button>
                    </div>
                    <button id="btnSaveUserChanges" class="save"><i class="fas fa-save"></i> Guardar Alterações</button>
                </div>
            </div>
        </div>
        
        <div id="confirmationModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="confirmationModalTitle">Confirmar Ação</h2>
                        <button id="confirmationModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <p id="confirmationModalMessage" style="white-space: pre-wrap;"></p>
                <div id="confirmationModalInputContainer" style="display: none; margin-top: 15px;">
                    <input type="text" id="confirmationModalInput" placeholder="Digite para confirmar">
                </div>
                <div class="modal-footer">
                    <button id="confirmationModalCancelBtn" class="btn-secondary">Cancelar</button>
                    <button id="confirmationModalConfirmBtn" class="save">Confirmar</button>
                </div>
            </div>
        </div>

        <div id="changePasswordModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header">
                    <h2>Alterar Senha</h2>
                    <button id="changePasswordModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <div class="input-group">
                    <label for="currentPassword">Senha Atual:</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="input-group">
                    <label for="newPassword">Nova Senha:</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="input-group">
                    <label for="confirmNewPassword">Confirmar Nova Senha:</label>
                    <input type="password" id="confirmNewPassword" required>
                </div>
                <div class="modal-footer">
                    <button id="changePasswordModalCancelBtn" class="btn-secondary">Cancelar</button>
                    <button id="changePasswordModalSaveBtn" class="save">Guardar Nova Senha</button>
                </div>
            </div>
        </div>

        <div id="adminPasswordConfirmModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Confirmar Ação</h2>
                    <button id="adminPasswordConfirmModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <p>Para criar um novo utilizador, por favor, confirme a sua senha de administrador.</p>
                <div class="input-group">
                    <label for="adminConfirmPassword">Sua Senha de Administrador:</label>
                    <input type="password" id="adminConfirmPassword" required>
                </div>
                <div class="modal-footer">
                    <button id="adminPasswordConfirmModalCancelBtn" class="btn-secondary">Cancelar</button>
                    <button id="adminPasswordConfirmModalConfirmBtn" class="save">Confirmar e Criar</button>
                </div>
            </div>
        </div>
        
        <div id="chartModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="chartModalTitle">Gráfico Expandido</h2>
                    <button id="chartModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <div id="expandedChartContainer">
                    <canvas id="expandedChartCanvas"></canvas>
                </div>
            </div>
        </div>

        <div id="editFarmModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Editar Fazenda</h2>
                    <button id="editFarmModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <input type="hidden" id="editingFarmId">
                <div class="input-group">
                    <label for="editFarmNameInput" class="required">Nome da Fazenda:</label>
                    <input type="text" id="editFarmNameInput" required>
                </div>
                <div class="checkbox-group-container">
                    <label>Tipo da Fazenda:</label>
                    <div class="checkbox-group-grid" id="editFarmTypeCheckboxes">
                        <label class="report-option-item"><input type="checkbox" name="editFarmType" value="Própria"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Própria</span></label>
                        <label class="report-option-item"><input type="checkbox" name="editFarmType" value="Parceira"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Parceira</span></label>
                        <label class="report-option-item"><input type="checkbox" name="editFarmType" value="Fornecedor"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Fornecedor</span></label>
                        <label class="report-option-item"><input type="checkbox" name="editFarmType" value="Acionista"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Acionista</span></label>
                        <label class="report-option-item"><input type="checkbox" name="editFarmType" value="Arrendatário"><span class="checkbox-visual"><i class="fas fa-check"></i></span><span class="option-content">Arrendatário</span></label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="editFarmModalCancelBtn" class="btn-secondary">Cancelar</button>
                    <button id="editFarmModalSaveBtn" class="save">Guardar Alterações</button>
                </div>
            </div>
        </div>

        <div id="editCompanyModal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="editCompanyModalTitle">Editar Empresa</h2>
                    <button id="editCompanyModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <input type="hidden" id="editingCompanyId">
                <p style="font-size: 16px;"><strong>Empresa:</strong> <span id="editCompanyNameDisplay" style="font-weight: 600; color: var(--color-primary);"></span></p>

                <div class="checkbox-group-container" style="margin-top: 20px;">
                    <label class="required" style="font-size: 15px; margin-bottom: 10px;">Módulos Subscritos:</label>
                    <div class="checkbox-group-grid" id="editCompanyModulesGrid">
                        <!-- Os módulos serão gerados aqui pelo app.js -->
                    </div>
                </div>

                <div class="modal-footer">
                    <button id="editCompanyModalCancelBtn" class="btn-secondary">Cancelar</button>
                    <button id="editCompanyModalSaveBtn" class="save">Guardar Alterações</button>
                </div>
            </div>
        </div>

        <div id="historyFilterModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h2>Filtro de Histórico</h2>
                    <button id="historyFilterModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <div class="form-col">
                    <label for="historyUserSelectModal" class="required">Utilizador:</label>
                    <select id="historyUserSelectModal" required></select>
                </div>
                <div class="form-row">
                    <div class="form-col">
                        <label for="historyStartDateModal" class="required">Data Início:</label>
                        <input type="date" id="historyStartDateModal" required />
                    </div>
                    <div class="form-col">
                        <label for="historyEndDateModal" class="required">Data Fim:</label>
                        <input type="date" id="historyEndDateModal" required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btnClearHistoryModal" class="btn-secondary" style="margin-right: auto; background: var(--color-danger);">Limpar Rota</button>
                    <button id="historyFilterModalCancelBtn" class="btn-secondary">Cancelar</button>
                    <button id="btnViewHistoryModal" class="save">Ver Rota</button>
                </div>
            </div>
        </div>

        <!-- NOVO: Modal para Detalhes do Histórico de Sincronização -->
        <div id="syncHistoryDetailModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 id="syncHistoryDetailModalTitle">Detalhes da Sincronização</h2>
                    <button id="syncHistoryDetailModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <div id="syncHistoryDetailModalBody" class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    <!-- O conteúdo será preenchido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button id="syncHistoryDetailModalCancelBtn" class="btn-secondary">Fechar</button>
                </div>
            </div>
        </div>

        <div id="configHistoryModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 id="configHistoryModalTitle">Histórico de Alterações de Configuração</h2>
                    <button id="configHistoryModalCloseBtn" class="modal-close-btn">&times;</button>
                </div>
                <div id="configHistoryModalBody" class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Histórico será renderizado aqui -->
                </div>
                <div class="modal-footer">
                    <button id="configHistoryModalCancelBtn" class="btn-secondary">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bibliotecas Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://unpkg.com/idb@7.1.1/build/index.js"></script>
    
    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
    <!-- Turf.js for spatial analysis -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

    <!-- Script principal da aplicação -->
    <script type="module" src="./app.js"></script>

</body>
</html>
